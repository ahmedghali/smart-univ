{% extends 'etudiant/base_Etu.html' %}
{% block content %}
{% load crispy_forms_tags %}

<div class="compact_zone m-1 p-2">
  <!-- En-tête compact -->
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <h5 class="border-bottom border-primary text-dark font-weight-bold mb-1">
        <i class="fas fa-graduation-cap"></i>
        {{ titre_01 }} - {{ my_Clas.type }}
      </h5>
      <small class="text-muted">
        <i class="fas fa-chalkboard-teacher"></i>
        {% if enseignant_info %}{{ enseignant_info.enseignant.nom_ar }} {{ enseignant_info.enseignant.prenom_ar }}{% endif %}
        | {{ titre_00 }}
      </small>
    </div>
    <div>
      <a href="{% url 'etud:timeTable_Etu' %}" class="btn btn-outline-secondary btn-sm me-1">
        <i class="fas fa-arrow-left"></i> العودة
      </a>
      {% if ma_Note %}
      <button class="btn btn-primary btn-sm" onclick="window.print()">
        <i class="fas fa-print"></i> طباعة
      </button>
      {% endif %}
    </div>
  </div>

  {% if not ma_Note %}
    <!-- Message compact si aucune note -->
    <div class="alert alert-info text-center py-2">
      <i class="fas fa-info-circle"></i>
      <strong>لا توجد نقاط مسجلة</strong> - يرجى المراجعة لاحقاً
    </div>
  {% else %}

  <!-- Layout principal compact -->
  <div class="row g-2">
    <!-- Colonne principale (النقاط + الإحصائيات) -->
    <div class="col-lg-8">
      <!-- النقاط الشخصية - Version compacte -->
      <div class="card border-primary mb-2">
        <div class="card-header bg-primary text-white py-1">
          <h6 class="mb-0">
            <i class="fas fa-star"></i>
            نقاطي التفصيلية
          </h6>
        </div>
        <div class="card-body py-2">
          <!-- النقاط الأساسية في صف واحد -->
          <div class="row g-2 mb-2">
            <!-- نقطة الحضور -->
            <div class="col-3">
              <div class="score-mini bg-success-subtle text-center p-2 rounded">
                <div class="score-value-mini text-success fw-bold">{{ ma_Note.note_presence|floatformat:2|default:"--" }}</div>
                <small class="text-muted">حضور /5</small>
              </div>
            </div>
            <!-- نقطة المشاركة -->
            <div class="col-3">
              <div class="score-mini bg-info-subtle text-center p-2 rounded">
                <div class="score-value-mini text-info fw-bold">{{ ma_Note.note_participe_HW|floatformat:2|default:"--" }}</div>
                <small class="text-muted">مشاركة /5</small>
              </div>
            </div>
            <!-- نقطة الامتحان 1 -->
            <div class="col-3">
              <div class="score-mini bg-warning-subtle text-center p-2 rounded">
                <div class="score-value-mini text-warning fw-bold">{{ ma_Note.note_controle_1|floatformat:2|default:"--" }}</div>
                <small class="text-muted">امتحان 1 /5</small>
              </div>
            </div>
            <!-- نقطة الامتحان 2 -->
            <div class="col-3">
              <div class="score-mini bg-warning-subtle text-center p-2 rounded">
                <div class="score-value-mini text-warning fw-bold">{{ ma_Note.note_controle_2|floatformat:2|default:"--" }}</div>
                <small class="text-muted">امتحان 2 /5</small>
              </div>
            </div>
            <!-- النقطة النهائية -->
            <div class="col-3">
              <div class="score-mini {% if ma_Note.note_finale >= 10 %}bg-success{% else %}bg-danger{% endif %}-subtle text-center p-2 rounded border {% if ma_Note.note_finale >= 10 %}border-success{% else %}border-danger{% endif %}">
                <div class="score-value-final {% if ma_Note.note_finale >= 10 %}text-success{% else %}text-danger{% endif %} fw-bold">{{ ma_Note.note_finale|floatformat:2|default:"--" }}</div>
                <small class="text-muted"><strong>النهائية /20</strong></small>
              </div>
            </div>
          </div>

          <!-- النقاط الإضافية - Version inline -->
          {% if ma_Note.total_sup_seance %}
          <div class="row g-2 pt-2 border-top">
            <div class="col-12">
              <small class="text-muted fw-bold">
                <i class="fas fa-plus-circle"></i> نقاط إضافية:
              </small>
              {% if ma_Note.total_sup_seance %}
                <span class="badge bg-success ms-1">+{{ ma_Note.total_sup_seance|floatformat:1 }} حصص</span>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- إحصائيات الصف - Version horizontale compacte -->
      {% if statistiques %}
      <div class="card border-light">
        <div class="card-header bg-light py-1">
          <h6 class="mb-0">
            <i class="fas fa-chart-bar"></i>
            إحصائيات الصف
          </h6>
        </div>
        <div class="card-body py-2">
          <div class="row text-center g-1">
            <div class="col-2">
              <div class="stat-mini">
                <div class="stat-value-mini text-primary">{{ statistiques.nombre_etudiants }}</div>
                <small class="text-muted">طلاب</small>
              </div>
            </div>
            <div class="col-2">
              <div class="stat-mini">
                <div class="stat-value-mini text-info">{{ statistiques.moyenne_classe|floatformat:2 }}</div>
                <small class="text-muted">معدل</small>
              </div>
            </div>
            <div class="col-2">
              <div class="stat-mini">
                <div class="stat-value-mini text-success">{{ statistiques.note_max|floatformat:2 }}</div>
                <small class="text-muted">أعلى</small>
              </div>
            </div>
            <div class="col-2">
              <div class="stat-mini">
                <div class="stat-value-mini text-danger">{{ statistiques.note_min|floatformat:2 }}</div>
                <small class="text-muted">أقل</small>
              </div>
            </div>
            <div class="col-2">
              <div class="stat-mini">
                <div class="stat-value-mini text-success">{{ statistiques.nombre_admis }}</div>
                <small class="text-muted">ناجح</small>
              </div>
            </div>
            <div class="col-2">
              <div class="stat-mini">
                <div class="stat-value-mini text-info">{{ statistiques.taux_reussite|floatformat:0 }}%</div>
                <small class="text-muted">نجاح</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Colonne latérale (التقدير + الحضور + الملاحظات) -->
    <div class="col-lg-4">
      <!-- التقدير - Version compacte -->
      <div class="card border-secondary mb-2">
        <div class="card-header bg-secondary text-white py-1">
          <h6 class="mb-0">
            <i class="fas fa-award"></i>
            التقدير
          </h6>
        </div>
        <div class="card-body text-center py-2">
          <div class="mention-badge-compact
            {% if ma_Note.mention == 'ممتاز' %}bg-success
            {% elif ma_Note.mention == 'جيد جداً' %}bg-info
            {% elif ma_Note.mention == 'جيد' %}bg-primary
            {% elif ma_Note.mention == 'مقبول' %}bg-warning
            {% else %}bg-danger{% endif %} text-white py-2 px-3 rounded">
            <div class="fw-bold">{{ ma_Note.mention|default:"غير محدد" }}</div>
          </div>
          {% if rang_etudiant %}
          <div class="mt-2">
            <small class="text-muted">الترتيب:</small>
            <div class="fw-bold text-primary">{{ rang_etudiant }}/{{ nombre_etudiants_classe }}</div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- الحضور - Version compacte -->
      <div class="card border-info mb-2">
        <div class="card-header bg-info text-white py-1">
          <h6 class="mb-0">
            <i class="fas fa-calendar-check"></i>
            الحضور
          </h6>
        </div>
        <div class="card-body text-center py-2">
          {% if ma_Note.taux_presence_pourcentage %}
          <div class="progress-mini
            {% if ma_Note.taux_presence_pourcentage >= 75 %}text-success
            {% elif ma_Note.taux_presence_pourcentage >= 50 %}text-warning
            {% else %}text-danger{% endif %}">
            <div class="h3 mb-0">{{ ma_Note.taux_presence_pourcentage }}%</div>
          </div>
          {% else %}
          <span class="text-muted">غير محدد</span>
          {% endif %}
        </div>
      </div>

      <!-- الملاحظات - Version compacte -->
      {% if ma_Note.obs %}
      <div class="card border-warning">
        <div class="card-header bg-warning py-1">
          <h6 class="mb-0">
            <i class="fas fa-comment"></i>
            ملاحظات
          </h6>
        </div>
        <div class="card-body py-2">
          <p class="mb-0 small fst-italic">{{ ma_Note.obs }}</p>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  {% endif %}
</div>

{% endblock %}

{% block extra_css_etu %}
<style>
/* Zone principale compacte */
.compact_zone {
    background-color: #f8f9fa;
    border-radius: 6px;
    max-width: 100%;
}

/* Cards compactes */
.card {
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: none;
}

.card-header {
    border-radius: 8px 8px 0 0 !important;
    font-weight: 600;
    padding: 0.5rem 0.75rem;
}

.card-body {
    padding: 0.5rem 0.75rem;
}

/* Scores mini */
.score-mini {
    transition: transform 0.1s ease;
    min-height: 60px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.score-mini:hover {
    transform: translateY(-1px);
}

.score-value-mini {
    font-size: 1.25rem;
    line-height: 1.2;
}

.score-value-final {
    font-size: 1.4rem;
    line-height: 1.2;
}

/* Stats mini */
.stat-mini {
    padding: 0.25rem;
}

.stat-value-mini {
    font-size: 1rem;
    font-weight: bold;
    margin-bottom: 0.125rem;
}

/* Badge de mention compact */
.mention-badge-compact {
    border-radius: 8px;
    display: inline-block;
    min-width: 120px;
}

/* Progress mini */
.progress-mini {
    padding: 0.5rem;
}

/* Couleurs de fond subtiles */
.bg-success-subtle { background-color: #e8f5e9 !important; }
.bg-info-subtle { background-color: #e3f2fd !important; }
.bg-warning-subtle { background-color: #fff8e1 !important; }
.bg-danger-subtle { background-color: #ffebee !important; }

/* Badges */
.badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
}

/* Responsive optimisé */
@media (max-width: 992px) {
    .col-lg-4 .card {
        margin-bottom: 0.5rem;
    }
}

@media (max-width: 768px) {
    .compact_zone {
        margin: 0 !important;
        padding: 0.5rem !important;
    }

    .score-mini {
        min-height: 50px;
    }

    .score-value-mini {
        font-size: 1rem;
    }

    .score-value-final {
        font-size: 1.2rem;
    }

    .stat-value-mini {
        font-size: 0.9rem;
    }

    .card-body {
        padding: 0.375rem 0.5rem;
    }

    .h3 {
        font-size: 1.5rem !important;
    }
}

@media (max-width: 576px) {
    .row.g-2 {
        margin: 0 -0.25rem;
    }

    .row.g-2 > * {
        padding: 0 0.25rem;
    }

    .score-value-mini {
        font-size: 0.9rem;
    }

    .stat-value-mini {
        font-size: 0.8rem;
    }
}

/* Impression optimisée */
@media print {
    .btn, .compact_zone {
        background: white !important;
    }

    .card {
        border: 1px solid #000 !important;
        box-shadow: none !important;
        margin-bottom: 0.5rem !important;
    }

    .card-header {
        background-color: #f8f9fa !important;
        color: #000 !important;
    }

    .score-mini, .stat-mini {
        border: 1px solid #ddd;
    }
}

/* Couleurs de texte */
.text-primary { color: #007bff !important; }
.text-success { color: #28a745 !important; }
.text-info { color: #17a2b8 !important; }
.text-warning { color: #ffc107 !important; }
.text-secondary { color: #6c757d !important; }
.text-danger { color: #dc3545 !important; }

/* Espacement réduit */
.g-1 > * { padding: 0.125rem; }
.g-2 > * { padding: 0.25rem; }

.mb-1 { margin-bottom: 0.25rem !important; }
.mb-2 { margin-bottom: 0.5rem !important; }
.py-1 { padding-top: 0.25rem !important; padding-bottom: 0.25rem !important; }
.py-2 { padding-top: 0.5rem !important; padding-bottom: 0.5rem !important; }

/* Border optimisé */
.border-top { border-top: 1px solid #dee2e6 !important; }
.border-bottom { border-bottom: 1px solid #dee2e6 !important; }
</style>
{% endblock %}
