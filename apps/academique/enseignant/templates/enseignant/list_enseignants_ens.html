{% extends 'enseignant/base_Ens.html' %}
{% load static %}

{# ═══════════════════════════════════════════════════════════════════════════════ #}
{# LISTE DES ENSEIGNANTS                                                           #}
{# Hérite de base_Ens.html - active_menu = 'enseignants'                           #}
{# ═══════════════════════════════════════════════════════════════════════════════ #}

{% block extra_css_ens %}
<style>
/* Largeurs des colonnes */
.col-number { width: 50px; text-align: center; }
.col-teacher { min-width: 180px; max-width: 220px; }
.col-status { width: 120px; text-align: center; }
.col-speciality { min-width: 180px; max-width: 220px; }
.col-taux { width: 110px; text-align: center; }
.col-email { min-width: 200px; max-width: 250px; }
.col-email-perso { min-width: 200px; max-width: 250px; }
.col-phone { width: 120px; text-align: center; }
.col-scholar { width: 120px; }
.col-post { width: 100px; text-align: center; }

/* Styles spécifiques pour les cellules */
.teacher-email small,
.teacher-email-perso small {
    font-size: 0.75rem;
    word-break: break-word;
}

.teacher-speciality small {
    font-size: 0.75rem;
    display: block;
}

.teacher-name strong {
    font-size: 0.9rem;
}

.stat-card-small {
    border-radius: 4px;
    padding: 8px;
    transition: all 0.3s ease;
}

.stat-card-small:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.stat-card-small strong {
    font-size: 1.2rem;
    display: block;
    margin-bottom: 4px;
}

/* Animation pour les warning badges */
@keyframes pulse-warning {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

.badge.bg-warning {
    animation: pulse-warning 2s infinite;
}

/* Responsive */
@media (max-width: 992px) {
    .col-email, .col-speciality, .col-email-perso {
        min-width: 150px;
    }
}
</style>
{% endblock %}

{% block content_ens %}
<div class="grey_zone m-1 p-2">
    <!-- EN-TÊTE PRINCIPAL -->
    <div class="main-header d-flex justify-content-between align-items-center mb-3">
        <h4 class="page-title border-bottom border-danger text-dark mb-0">
            <i class="fas fa-chalkboard-teacher"></i>
            قائمة أساتذة قسم {{my_Dep.nom_ar}} - السداسي
            {% if semestre_num == 1 %}الأول{% else %}الثاني{% endif %}
        </h4>

        <!-- Boutons pour basculer entre semestres -->
        <div class="semester-selector btn-group" role="group">
            <a href="{% url 'ense:list_enseignants_ens' my_Dep.id %}?semestre=1"
               class="btn {% if semestre_num == 1 %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">
                <i class="fas fa-calendar-alt"></i> السداسي الأول
            </a>
            <a href="{% url 'ense:list_enseignants_ens' my_Dep.id %}?semestre=2"
               class="btn {% if semestre_num == 2 %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">
                <i class="fas fa-calendar-alt"></i> السداسي الثاني
            </a>
        </div>
    </div>

    <!-- Statistiques globales -->
    <div class="statistics-section">
        <div class="card statistics-card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> إحصائيات الأساتذة</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="stat-card text-center p-3 bg-primary-subtle rounded">
                            <h3 class="text-primary mb-0">{{total_enseignants}}</h3>
                            <small class="text-muted">إجمالي الأساتذة</small>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="stat-card text-center p-3 bg-success-subtle rounded">
                            <h4 class="text-success mb-0">{{count_per}}</h4>
                            <small class="text-muted">المرسمين</small>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="stat-card text-center p-3 bg-warning-subtle rounded">
                            <h4 class="text-warning mb-0">{{count_temp}}</h4>
                            <small class="text-muted">المؤقتين</small>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="stat-card text-center p-3 bg-info-subtle rounded">
                            <h4 class="text-info mb-0">{{count_scholar}}</h4>
                            <small class="text-muted">لديهم Google Scholar</small>
                        </div>
                    </div>
                </div>

                <!-- Statistiques par grade -->
                <div class="row">
                    <div class="col-12">
                        <h6 class="text-muted mb-2"><i class="fas fa-graduation-cap"></i> توزيع الأساتذة حسب الرتبة:</h6>
                        <div class="row">
                            {% for stat in grade_stats %}
                            <div class="col-md-3 col-sm-6 mb-2">
                                <div class="stat-card-small text-center p-2 bg-light rounded border">
                                    <strong class="text-primary">{{stat.count}}</strong>
                                    <small class="d-block text-muted">{{stat.enseignant__grade__nom_ar|default:"غير محدد"}}</small>
                                </div>
                            </div>
                            {% empty %}
                            <div class="col-12"><p class="text-muted text-center">لا توجد بيانات</p></div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tableau liste des enseignants -->
    <div class="teachers-table-section">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-users"></i> قائمة الأساتذة التفصيلية - السداسي {% if semestre_num == 1 %}الأول{% else %}الثاني{% endif %}</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm align-middle mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th class="col-number">#</th>
                                <th class="col-teacher"><i class="fas fa-user"></i> الأستاذ</th>
                                <th class="col-speciality"><i class="fas fa-book"></i> التخصص</th>
                                <th class="col-taux"><i class="fas fa-chart-line"></i> أقل %</th>
                                <th class="col-taux"><i class="fas fa-percentage"></i> متوسط %</th>
                                <th class="col-email"><i class="fas fa-envelope"></i> الإيميل المهني</th>
                                <th class="col-email-perso"><i class="fas fa-envelope-open"></i> الإيميل الشخصي</th>
                                <th class="col-phone"><i class="fas fa-phone"></i> الجوال</th>
                                <th class="col-scholar text-center"><i class="fas fa-graduation-cap"></i> Scholar</th>
                                <th class="col-post"><i class="fas fa-briefcase"></i> المنصب</th>
                                <th class="col-status"><i class="fas fa-id-badge"></i> الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ens in all_Ens_Dep %}
                            <tr class="teacher-row">
                                <td class="teacher-number"><span class="badge bg-primary">{{forloop.counter}}</span></td>
                                <td class="teacher-name"><strong>{{ens.enseignant.nom_ar}} {{ens.enseignant.prenom_ar}}</strong></td>
                                <td class="teacher-speciality">
                                    {% if ens.enseignant.specialite_fr %}<small>{{ens.enseignant.specialite_fr}}</small>
                                    {% else %}<small class="text-muted">-</small>{% endif %}
                                </td>
                                <td class="teacher-taux text-center">
                                    {% if ens.taux_min_display == 0 %}<span class="badge bg-secondary">0%</span>
                                    {% elif ens.taux_min_display < 50 %}<span class="badge bg-danger">{{ens.taux_min_display}}%</span>
                                    {% elif ens.taux_min_display < 75 %}<span class="badge bg-warning text-dark">{{ens.taux_min_display}}%</span>
                                    {% elif ens.taux_min_display < 90 %}<span class="badge bg-info text-dark">{{ens.taux_min_display}}%</span>
                                    {% else %}<span class="badge bg-success">{{ens.taux_min_display}}%</span>{% endif %}
                                </td>
                                <td class="teacher-taux text-center">
                                    {% if ens.taux_moy_display == 0 %}<span class="badge bg-secondary">0%</span>
                                    {% elif ens.taux_moy_display < 50 %}<span class="badge bg-danger">{{ens.taux_moy_display}}%</span>
                                    {% elif ens.taux_moy_display < 75 %}<span class="badge bg-warning text-dark">{{ens.taux_moy_display}}%</span>
                                    {% elif ens.taux_moy_display < 90 %}<span class="badge bg-info text-dark">{{ens.taux_moy_display}}%</span>
                                    {% else %}<span class="badge bg-success">{{ens.taux_moy_display}}%</span>{% endif %}
                                </td>
                                <td class="teacher-email">
                                    {% if ens.enseignant.email_prof %}<small class="text-muted">{{ens.enseignant.email_prof}}</small>
                                    {% else %}<span class="badge bg-warning text-dark"><i class="fas fa-exclamation-triangle"></i> غير محدد</span>{% endif %}
                                </td>
                                <td class="teacher-email-perso">
                                    {% if ens.enseignant.email_perso %}<small class="text-muted">{{ens.enseignant.email_perso}}</small>
                                    {% else %}<span class="badge bg-warning text-dark"><i class="fas fa-exclamation-triangle"></i> غير محدد</span>{% endif %}
                                </td>
                                <td class="teacher-phone text-center">
                                    {% if ens.enseignant.telmobile1 %}<small>{{ens.enseignant.telmobile1}}</small>
                                    {% else %}<small class="text-muted">-</small>{% endif %}
                                </td>
                                <td class="teacher-scholar text-center">
                                    {% if ens.enseignant.googlescholar %}<span class="badge bg-success"><i class="fas fa-check-circle"></i> نعم</span>
                                    {% else %}<span class="badge bg-danger"><i class="fas fa-times-circle"></i> لا</span>{% endif %}
                                </td>
                                <td class="teacher-post text-center">
                                    {% if ens.enseignant.user and ens.enseignant.user.poste_principal %}
                                        {% if ens.enseignant.user.poste_principal.code == 'ENS' %}<small class="text-muted">-</small>
                                        {% else %}<small>{{ens.enseignant.user.poste_principal.nom_ar_mini}}</small>{% endif %}
                                    {% else %}<small class="text-muted">-</small>{% endif %}
                                </td>
                                <td class="teacher-status text-center">
                                    {% if ens.statut == 'Permanent' %}<span class="badge bg-success">دائم</span>
                                    {% elif ens.statut == 'Permanent & Vacataire' %}<span class="badge bg-warning text-dark">مرسم و مؤقت</span>
                                    {% elif ens.statut == 'Vacataire' %}<span class="badge bg-info">مؤقت</span>
                                    {% elif ens.statut == 'Associe' %}<span class="badge bg-secondary">مشارك</span>
                                    {% elif ens.statut == 'Doctorant' %}<span class="badge bg-primary">دكتوراه</span>
                                    {% else %}<span class="badge bg-light text-dark">{{ens.statut}}</span>{% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="11" class="text-center text-muted py-4">
                                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                                    <p>لا توجد بيانات لعرضها</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animation des statistiques
    const statNumbers = document.querySelectorAll('.stat-card h3, .stat-card h4, .stat-card-small strong');
    statNumbers.forEach(function(el) {
        const finalValue = parseInt(el.textContent) || 0;
        if (finalValue > 0) {
            let current = 0;
            const increment = finalValue / 30;
            const timer = setInterval(function() {
                current += increment;
                if (current >= finalValue) { current = finalValue; clearInterval(timer); }
                el.textContent = Math.floor(current);
            }, 16);
        }
    });
});
</script>
{% endblock %}
