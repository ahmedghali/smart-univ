{% extends 'enseignant/base_Ens.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load l10n %}

{# ═══════════════════════════════════════════════════════════════════════════════ #}
{# LISTE DES NOTES PAR CLASSE                                                      #}
{# Hérite de base_Ens.html - Gestion des notes des étudiants                       #}
{# ═══════════════════════════════════════════════════════════════════════════════ #}

{% block extra_css_ens %}
<style>
/* Table ultra-compacte */
.compact-table {
    line-height: 1.2;
}

.compact-table th,
.compact-table td {
    padding: 0.2rem 0.3rem !important;
    vertical-align: middle;
    border: 1px solid #dee2e6;
    height: 35px !important;
    max-height: 35px !important;
}

.compact-header th {
    font-weight: 600;
    height: 50px !important;
    white-space: nowrap;
    vertical-align: middle;
}

.compact-row {
    height: 35px !important;
    max-height: 35px !important;
}

/* Inputs ultra-compacts */
.ultra-compact {
    height: 28px !important;
    padding: 0.2rem 0.3rem !important;
    line-height: 1.2 !important;
    border: 1px solid #ced4da;
}

.ultra-compact:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.1rem rgba(40, 167, 69, 0.15);
}

/* Bonus compacts */
.compact-bonus {
    align-items: center;
    gap: 3px;
}

.bonus-compact {
    min-width: 22px;
    text-align: center;
}

/* Badge compact */
.badge-compact {
    font-size: 0.6rem !important;
    padding: 0.2rem 0.4rem !important;
    line-height: 1.1;
}

/* Checkboxes compactes */
.compact-checkbox {
    font-size: 0.75rem !important;
    margin-right: 8px !important;
    margin-bottom: 0 !important;
    cursor: pointer;
    white-space: nowrap;
}

.compact-checkbox input[type="checkbox"] {
    margin-right: 3px;
    transform: scale(0.9);
}

/* Boutons compacts */
.btn-sm {
    padding: 0.3rem 0.6rem;
}

/* Hover optimisé */
.table-hover tbody tr:hover {
    background-color: #e8f5e8 !important;
}

/* Style général compact */
.grey_zone {
    background-color: #f8f9fa;
    border-radius: 6px;
}

.oneBorder {
    border-left: 3px solid #28a745;
    padding-left: 8px;
}

/* Card compact */
.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card-body {
    padding: 0.5rem !important;
}

/* Stat boxes - agrandis */
.stat-box {
    padding: 0.5rem;
    border-radius: 8px;
    transition: transform 0.2s, box-shadow 0.2s;
}

.stat-box:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.stat-box h4 {
    font-size: 1.8rem;
    margin: 0;
}

.stat-box p {
    font-size: 0.9rem;
    margin: 0;
}

/* Thead sticky mais compact */
thead th {
    position: sticky;
    top: 0;
    background-color: #212529 !important;
    color: #ffffff !important;
    z-index: 10;
    font-weight: 600;
}

/* Assurer que table-dark a les bonnes couleurs */
.table-dark th {
    background-color: #212529 !important;
    color: #ffffff !important;
    border-color: #373b3e !important;
}

/* En-têtes colorés - garder les couleurs spécifiques avec texte blanc */
thead th[style*="background-color"] {
    color: #ffffff !important;
}

/* Amélioration des en-têtes avec sous-titres */
.compact-header th small {
    display: block;
    font-weight: 400;
    opacity: 0.9;
}

/* Responsive ultra-compact */
@media (max-width: 768px) {
    .compact-table {
        font-size: 0.65rem;
    }

    .compact-table th,
    .compact-table td {
        padding: 0.1rem 0.2rem !important;
        height: 30px !important;
    }

    .compact-header th {
        height: 45px !important;
    }

    .ultra-compact {
        width: 40px !important;
        height: 24px !important;
        font-size: 0.6rem !important;
        padding: 0.1rem 0.2rem !important;
    }

    .compact-checkbox {
        font-size: 0.65rem !important;
        margin-right: 5px !important;
    }

    .btn-sm {
        font-size: 0.65rem;
        padding: 0.2rem 0.4rem;
    }
}

@media (max-width: 576px) {
    .compact-table th,
    .compact-table td {
        padding: 0.1rem !important;
        height: 28px !important;
        font-size: 0.6rem;
    }

    .compact-header th {
        font-size: 0.6rem;
        height: 40px !important;
    }

    .ultra-compact {
        width: 35px !important;
        height: 22px !important;
        font-size: 0.55rem !important;
    }
}

/* Suppression des marges inutiles */
small {
    line-height: 1.2;
}

.text-center small {
    display: inline-block;
}

/* Animation disabled pour performance */
.table tbody tr {
    opacity: 1;
    animation: none;
}

/* Performance optimizations */
* {
    box-sizing: border-box;
}

/* No transitions on table for performance */
.compact-table * {
    transition: none !important;
}

/* Focus states optimized */
.ultra-compact:focus {
    outline: none;
    border-color: #28a745;
    box-shadow: 0 0 0 1px rgba(40, 167, 69, 0.3);
}

/* Sortable cursor */
.sortable:hover {
    background-color: rgba(255, 255, 255, 0.1);
    cursor: pointer;
}

/* Indicateur de tri */
.sort-indicator {
    display: inline-block;
    font-weight: bold;
    transition: opacity 0.2s;
}

.sorted {
    background-color: rgba(255, 255, 255, 0.2) !important;
}

/* Minimal spacing */
.mb-1 { margin-bottom: 0.25rem !important; }
.mb-2 { margin-bottom: 0.5rem !important; }
.me-1 { margin-right: 0.25rem !important; }
.p-1 { padding: 0.25rem !important; }

/* Coloration des bonus */
.bonus-compact .text-success {
    color: #198754 !important;
    font-weight: bold;
}

.bonus-compact .text-info {
    color: #0dcaf0 !important;
    font-weight: bold;
}
</style>
{% endblock %}

{% block content_ens %}
<div class="grey_zone m-1 p-2">
  <!-- En-tête de la page -->
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <h5 class="border-bottom border-success text-dark font-weight-bold mb-2">
        <i class="fas fa-graduation-cap"></i>
        نقاط طلاب: {{ titre_00 }}
      </h5>
      <h6 class="oneBorder mb-1">
        المادة: <span class="text-success fw-bold">{{ titre_01 }}</span>
        <span class="badge bg-secondary ms-2">{{ type_classe }}</span>
      </h6>
    </div>
    <div>
      <a href="{% url 'ense:timeTable_Ens' my_Dep.id %}" class="btn btn-outline-secondary btn-sm me-1">
        <i class="fas fa-arrow-left"></i> العودة
      </a>
      <!-- Boutons d'export -->
      <button type="button" class="btn btn-success btn-sm me-1" id="export-excel">
        <i class="fas fa-file-excel"></i> تصدير Excel
      </button>
      <button type="button" class="btn btn-sm" id="export-pdf" style="background-color: #b22222; color: white;">
        <i class="fas fa-file-pdf"></i> تصدير PDF
      </button>
    </div>
  </div>

  <!-- Statistiques de la classe -->
  {% if statistiques %}
  <div class="card mb-3 shadow-sm">
    <div class="card-body py-3">
      <div class="row text-center g-3">
        <div class="col-md-2 col-sm-4 col-6">
          <div class="stat-box">
            <h4 class="text-primary fw-bold mb-1">{{ statistiques.nombre_etudiants }}</h4>
            <p class="text-muted mb-0" style="font-size: 0.9rem;">طلاب</p>
          </div>
        </div>
        <div class="col-md-2 col-sm-4 col-6">
          <div class="stat-box">
            <h4 class="text-info fw-bold mb-1">{{ statistiques.moyenne_classe }}</h4>
            <p class="text-muted mb-0" style="font-size: 0.9rem;">معدل الصف</p>
          </div>
        </div>
        <div class="col-md-2 col-sm-4 col-6">
          <div class="stat-box">
            <h4 class="text-success fw-bold mb-1">{{ statistiques.note_max }}</h4>
            <p class="text-muted mb-0" style="font-size: 0.9rem;">أعلى نقطة</p>
          </div>
        </div>
        <div class="col-md-2 col-sm-4 col-6">
          <div class="stat-box">
            <h4 class="text-danger fw-bold mb-1">{{ statistiques.note_min }}</h4>
            <p class="text-muted mb-0" style="font-size: 0.9rem;">أقل نقطة</p>
          </div>
        </div>
        <div class="col-md-2 col-sm-4 col-6">
          <div class="stat-box">
            <h4 class="text-success fw-bold mb-1">{{ statistiques.nombre_admis }}</h4>
            <p class="text-muted mb-0" style="font-size: 0.9rem;">ناجح</p>
          </div>
        </div>
        <div class="col-md-2 col-sm-4 col-6">
          <div class="stat-box">
            <h4 class="text-info fw-bold mb-1">{{ statistiques.taux_reussite }}%</h4>
            <p class="text-muted mb-0" style="font-size: 0.9rem;">نسبة النجاح</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Contrôles compacts -->
  <div class="mb-2 d-flex justify-content-between align-items-center">
    <div class="d-flex flex-wrap align-items-center">
      <small class="fw-bold me-2">إظهار:</small>
      <label class="compact-checkbox"><input type="checkbox" id="toggle-index" checked> #</label>
      <label class="compact-checkbox"><input type="checkbox" id="toggle-nom_fr" checked> Nom</label>
      <label class="compact-checkbox"><input type="checkbox" id="toggle-prenom_fr" checked> Prénom</label>
      <label class="compact-checkbox"><input type="checkbox" id="toggle-nom_ar" checked> اللقب</label>
      <label class="compact-checkbox"><input type="checkbox" id="toggle-prenom_ar" checked> الاسم</label>
      <label class="compact-checkbox"><input type="checkbox" id="toggle-notes" checked> النقاط</label>
      <label class="compact-checkbox"><input type="checkbox" id="toggle-absences" checked> غيابات</label>
      <label class="compact-checkbox"><input type="checkbox" id="toggle-participation" checked> مشاركة</label>
      <label class="compact-checkbox"><input type="checkbox" id="toggle-mention" checked> التقييم</label>
      <label class="compact-checkbox"><input type="checkbox" id="toggle-obs" checked> ملاحظات</label>
    </div>
    <div>
      {% if not notes_validees %}
      <button type="button" class="btn btn-primary btn-sm" id="save-all-notes">
        <i class="fas fa-save"></i> حفظ
      </button>
      <button type="button" class="btn btn-warning btn-sm" id="validate-all-notes">
        <i class="fas fa-check-circle"></i> تصديق
      </button>
      {% else %}
      <span class="badge bg-success"><i class="fas fa-check"></i> النقاط مصدّقة</span>
      {% endif %}
    </div>
  </div>

  <!-- Formulaire des notes -->
  <form method="post" id="notes-form">
    {% csrf_token %}

    <!-- Table des notes ultra-compacte -->
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm table-bordered align-middle compact-table" id="notes-table">
        <thead class="table-dark">
          <tr class="compact-header">
            <th data-col="index" class="toggle-col text-center p-1 sortable">#</th>
            <th data-col="nom_fr" class="toggle-col sortable p-1">Nom</th>
            <th data-col="prenom_fr" class="toggle-col sortable p-1">Prénom</th>
            <th data-col="nom_ar" class="toggle-col sortable p-1">اللقب</th>
            <th data-col="prenom_ar" class="toggle-col sortable p-1">الاسم</th>
            <th data-col="notes" class="toggle-col text-center p-1 sortable" style="background-color: #0a58ca !important;">حضور<br><small>آلي</small></th>
            <th data-col="notes" class="toggle-col text-center p-1 sortable" style="background-color: #087990 !important;">واجبات<br><small>(0-5)</small></th>
            <th data-col="notes" class="toggle-col text-center p-1 sortable" style="background-color: #997404 !important; color: white !important;">امتحان 1<br><small>(0-5)</small></th>
            <th data-col="notes" class="toggle-col text-center p-1 sortable" style="background-color: #b02a37 !important;">امتحان 2<br><small>(0-5)</small></th>
            <th data-col="notes" class="toggle-col text-center p-1 sortable">إضافة<br><small>آلية</small></th>
            <th data-col="notes" class="toggle-col text-center p-1 sortable">%حضور</th>
            <th data-col="absences" class="toggle-col text-center p-1 sortable" style="background-color: #6c757d !important;">غيابات<br><small>كلية</small></th>
            <th data-col="absences" class="toggle-col text-center p-1 sortable" style="background-color: #5c636a !important;">مبررة<br><small>غيابات</small></th>
            <th data-col="participation" class="toggle-col text-center p-1 sortable">مشاركة<br><small>عدد</small></th>
            <th data-col="notes" class="toggle-col text-center p-1 sortable" style="background-color: #997404 !important;"><strong>النهائية<br><small>(0-20)</small></strong></th>
            <th data-col="mention" class="toggle-col text-center p-1 sortable">التقييم</th>
            <th data-col="obs" class="toggle-col text-center p-1 sortable">ملاحظات</th>
          </tr>
        </thead>
        <tbody>
          {% for note in all_Notes_Classe %}
            <tr data-nom_ar="{{ note.etudiant.nom_ar|default:''|lower }}"
                data-prenom_ar="{{ note.etudiant.prenom_ar|default:''|lower }}"
                data-nom_fr="{{ note.etudiant.nom_fr|default:''|lower }}"
                data-prenom_fr="{{ note.etudiant.prenom_fr|default:''|lower }}"
                data-note_finale="{{ note.note_finale }}"
                data-index="{{ forloop.counter }}"
                data-note_presence="{{ note.note_presence }}"
                data-note_participe_hw="{{ note.note_participe_HW }}"
                data-note_controle_1="{{ note.note_controle_1 }}"
                data-note_controle_2="{{ note.note_controle_2 }}"
                data-total_sup_seance="{{ note.total_sup_seance|default:0 }}"
                data-taux_presence="{{ note.taux_presence_pourcentage|default:0 }}"
                data-nbr_absence="{{ note.nbr_absence|default:0 }}"
                data-nbr_absence_justifiee="{{ note.nbr_absence_justifiee|default:0 }}"
                data-nb_participations="{{ note.nombre_participations|default:0 }}"
                data-mention="{{ note.mention|default:'' }}"
                class="compact-row">

              <!-- Informations étudiant -->
              <td data-col="index" class="toggle-col text-center p-1">
                <small>{{ forloop.counter }}</small>
              </td>
              <td data-col="nom_fr" class="toggle-col p-1">
                <small>{{ note.etudiant.nom_fr|default:'-' }}</small>
              </td>
              <td data-col="prenom_fr" class="toggle-col p-1">
                <small>{{ note.etudiant.prenom_fr|default:'-' }}</small>
              </td>
              <td data-col="nom_ar" class="toggle-col p-1">
                <small>{{ note.etudiant.nom_ar|default:'-' }}</small>
              </td>
              <td data-col="prenom_ar" class="toggle-col p-1">
                <small>{{ note.etudiant.prenom_ar|default:'-' }}</small>
              </td>

              <!-- Note de présence (calculée automatiquement - lecture seule) -->
              <td data-col="notes" class="toggle-col text-center p-1 bg-light">
                <strong class="{% if note.note_presence >= 4 %}text-success{% elif note.note_presence >= 2 %}text-warning{% else %}text-danger{% endif %}">
                  <small>{{ note.note_presence|floatformat:2|default:"5.00" }}</small>
                </strong>
                <input type="hidden" name="note_presence_{{ note.etudiant.id }}" value="{{ note.note_presence|default:5 }}">
              </td>

              <!-- Note de participation -->
              <td data-col="notes" class="toggle-col text-center p-1">
                {% localize off %}
                <input type="number"
                       name="note_participe_HW_{{ note.etudiant.id }}"
                       value="{{ note.note_participe_HW|default:0 }}"
                       min="0" max="5" step="0.25"
                       class="form-control form-control-sm text-center note-input ultra-compact"
                       {% if note.validee_par_enseignant %}readonly{% endif %}>
                {% endlocalize %}
              </td>

              <!-- Note de contrôle 1 -->
              <td data-col="notes" class="toggle-col text-center p-1">
                {% localize off %}
                <input type="number"
                       name="note_controle_1_{{ note.etudiant.id }}"
                       value="{{ note.note_controle_1|default:0 }}"
                       min="0" max="5" step="0.25"
                       class="form-control form-control-sm text-center note-input ultra-compact"
                       {% if note.validee_par_enseignant %}readonly{% endif %}>
                {% endlocalize %}
              </td>

              <!-- Note de contrôle 2 -->
              <td data-col="notes" class="toggle-col text-center p-1">
                {% localize off %}
                <input type="number"
                       name="note_controle_2_{{ note.etudiant.id }}"
                       value="{{ note.note_controle_2|default:0 }}"
                       min="0" max="5" step="0.25"
                       class="form-control form-control-sm text-center note-input ultra-compact"
                       {% if note.validee_par_enseignant %}readonly{% endif %}>
                {% endlocalize %}
              </td>

              <!-- Points supplémentaires -->
              <td data-col="notes" class="toggle-col text-center p-1">
                <div class="d-flex justify-content-center compact-bonus">
                  <div class="bonus-compact me-1" title="مشاركة: {{ note.total_sup_seance|default:0|floatformat:2 }}">
                    <small class="text-success fw-bold">{{ note.total_sup_seance|default:0|floatformat:1 }}</small>
                  </div>
                </div>
                <input type="hidden" name="total_sup_seance_{{ note.etudiant.id }}" value="{{ note.total_sup_seance|default:0 }}">
              </td>

              <!-- Taux de présence -->
              <td data-col="notes" class="toggle-col text-center p-1">
                <small class="{% if note.taux_presence_pourcentage >= 75 %}text-success{% elif note.taux_presence_pourcentage >= 50 %}text-warning{% else %}text-danger{% endif %}">
                  {{ note.taux_presence_pourcentage|default:0 }}%
                </small>
              </td>

              <!-- Nombre total d'absences - Rouge -->
              <td data-col="absences" class="toggle-col text-center p-1">
                <span class="badge bg-danger badge-compact">
                  <small>{{ note.nbr_absence|default:0 }}</small>
                </span>
              </td>

              <!-- Nombre d'absences justifiées - Orange -->
              <td data-col="absences" class="toggle-col text-center p-1">
                <span class="badge bg-warning text-dark badge-compact">
                  <small>{{ note.nbr_absence_justifiee|default:0 }}</small>
                </span>
              </td>

              <!-- Nombre de participations -->
              <td data-col="participation" class="toggle-col text-center p-1">
                <span class="badge {% if note.nombre_participations > 0 %}bg-primary{% else %}bg-secondary{% endif %} badge-compact">
                  <small>{{ note.nombre_participations|default:0 }}</small>
                </span>
              </td>

              <!-- Note finale -->
              <td data-col="notes" class="toggle-col text-center p-1 bg-light">
                <strong class="{% if note.note_finale >= 10 %}text-success{% else %}text-danger{% endif %}">
                  <small>{{ note.note_finale|stringformat:".2f" }}</small>
                </strong>
              </td>

              <!-- Mention -->
              <td data-col="mention" class="toggle-col text-center p-1">
                <span class="badge badge-compact
                  {% if note.mention == 'ممتاز' %}bg-success
                  {% elif note.mention == 'جيد جداً' %}bg-info
                  {% elif note.mention == 'جيد' %}bg-primary
                  {% elif note.mention == 'مقبول' %}bg-warning
                  {% else %}bg-danger{% endif %}">
                  <small>{{ note.mention|default:'لا شيء' }}</small>
                </span>
              </td>

              <!-- Observations -->
              <td data-col="obs" class="toggle-col p-1">
                <input type="text"
                       name="obs_{{ note.etudiant.id }}"
                       value="{{ note.obs|default:'' }}"
                       class="form-control form-control-sm ultra-compact obs-input"
                       placeholder="ملاحظة..."
                       {% if note.validee_par_enseignant %}readonly{% endif %}>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="17" class="text-center p-2">
                <small class="text-muted">
                  <i class="fas fa-info-circle"></i>
                  لا توجد نقاط مسجلة بعد
                </small>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>
</div>

<!-- Modal de confirmation pour la validation - Étape 1 -->
<div class="modal fade" id="validateModal1" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header py-2 bg-warning">
        <h6 class="modal-title"><i class="fas fa-exclamation-triangle"></i> تأكيد التصديق</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body py-3">
        <p class="mb-2 text-center">هل أنت متأكد من التصديق على جميع النقاط؟</p>
        <p class="text-danger text-center mb-0"><small><strong>تحذير:</strong> بعد التصديق لن يمكن تعديل النقاط نهائياً!</small></p>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">إلغاء</button>
        <button type="button" class="btn btn-warning btn-sm" id="confirm-step1">
          <i class="fas fa-arrow-left"></i> متابعة
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmation pour la validation - Étape 2 (mot de passe) -->
<div class="modal fade" id="validateModal2" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header py-2 bg-danger text-white">
        <h6 class="modal-title"><i class="fas fa-lock"></i> تأكيد كلمة المرور</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{% url 'ense:valider_notes_classe' my_Dep.id my_Clas.id %}" id="validate-form">
        {% csrf_token %}
        <div class="modal-body py-3">
          <p class="text-center mb-3">أدخل كلمة المرور للتأكيد النهائي</p>
          <div class="mb-3">
            <label for="password-confirm" class="form-label">كلمة المرور</label>
            <input type="password" class="form-control" id="password-confirm" name="password" required placeholder="أدخل كلمة المرور">
            <div class="invalid-feedback" id="password-error">كلمة المرور غير صحيحة</div>
          </div>
        </div>
        <div class="modal-footer py-2">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">إلغاء</button>
          <button type="submit" class="btn btn-danger btn-sm">
            <i class="fas fa-check-circle"></i> تصديق نهائي
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js_ens %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let table = document.getElementById('notes-table');
    if (!table) return;

    let tbody = table.getElementsByTagName('tbody')[0];
    let ths = table.getElementsByTagName('th');
    let sortDirection = {};

    // Afficher/masquer les colonnes
    let toggleCheckboxes = document.querySelectorAll('input[id^="toggle-"]');
    toggleCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            let col = this.id.replace('toggle-', '');
            let elements = document.querySelectorAll(`[data-col="${col}"]`);
            elements.forEach(el => el.style.display = this.checked ? '' : 'none');
        });
    });

    // Tri dynamique - Toutes les colonnes sont maintenant triables
    for (let th of ths) {
        if (th.classList.contains('sortable')) {
            th.style.cursor = 'pointer';

            th.addEventListener('mouseenter', function() {
                if (!this.querySelector('.sort-indicator')) {
                    let indicator = document.createElement('span');
                    indicator.className = 'sort-indicator ms-1';
                    indicator.innerHTML = '⇅';
                    indicator.style.opacity = '0.5';
                    this.appendChild(indicator);
                }
            });

            th.addEventListener('mouseleave', function() {
                let indicator = this.querySelector('.sort-indicator');
                if (indicator && !this.classList.contains('sorted')) {
                    indicator.remove();
                }
            });

            th.addEventListener('click', function() {
                let key;
                let thText = this.textContent.trim().toLowerCase();

                // Mapping des en-têtes vers les attributs data-*
                if (thText.includes('#')) key = 'index';
                else if (thText.includes('nom')) key = 'nom_fr';
                else if (thText.includes('prénom')) key = 'prenom_fr';
                else if (thText.includes('اللقب')) key = 'nom_ar';
                else if (thText.includes('الاسم')) key = 'prenom_ar';
                else if (thText.includes('حضور') && thText.includes('0-5')) key = 'note_presence';
                else if (thText.includes('واجبات')) key = 'note_participe_hw';
                else if (thText.includes('امتحان 1')) key = 'note_controle_1';
                else if (thText.includes('امتحان 2')) key = 'note_controle_2';
                else if (thText.includes('إضاف')) key = 'total_sup_seance';
                else if (thText.includes('النهائية')) key = 'note_finale';
                else if (thText.includes('%حضور')) key = 'taux_presence';
                else if (thText.includes('غيابات') && thText.includes('كلية')) key = 'nbr_absence';
                else if (thText.includes('مبررة')) key = 'nbr_absence_justifiee';
                else if (thText.includes('مشاركة')) key = 'nb_participations';
                else if (thText.includes('التقييم')) key = 'mention';
                else key = 'index';

                let rows = Array.from(tbody.getElementsByTagName('tr'));
                sortDirection[key] = !sortDirection[key];

                document.querySelectorAll('.sorted').forEach(el => el.classList.remove('sorted'));
                this.classList.add('sorted');

                let indicator = this.querySelector('.sort-indicator');
                if (!indicator) {
                    indicator = document.createElement('span');
                    indicator.className = 'sort-indicator ms-1';
                    this.appendChild(indicator);
                }
                indicator.innerHTML = sortDirection[key] ? '↑' : '↓';
                indicator.style.opacity = '1';

                rows.sort((a, b) => {
                    let aValue = a.getAttribute(`data-${key}`) || '';
                    let bValue = b.getAttribute(`data-${key}`) || '';

                    let isNumeric = ['index', 'note_presence', 'note_participe_hw', 'note_controle_1',
                                    'note_controle_2', 'total_sup_seance', 'note_finale',
                                    'taux_presence', 'nbr_absence', 'nbr_absence_justifiee', 'nb_participations'].includes(key);

                    if (isNumeric) {
                        aValue = parseFloat(aValue) || 0;
                        bValue = parseFloat(bValue) || 0;
                    } else {
                        aValue = aValue.toLowerCase();
                        bValue = bValue.toLowerCase();
                    }

                    if (aValue < bValue) return sortDirection[key] ? -1 : 1;
                    if (aValue > bValue) return sortDirection[key] ? 1 : -1;
                    return 0;
                });

                rows.forEach(row => tbody.appendChild(row));
                updateRowNumbers();
            });
        }
    }

    // Fonction pour mettre à jour les numéros de ligne
    function updateRowNumbers() {
        let rows = tbody.getElementsByTagName('tr');
        for (let i = 0; i < rows.length; i++) {
            let indexCell = rows[i].querySelector('td[data-col="index"]');
            if (indexCell) {
                indexCell.querySelector('small').textContent = i + 1;
                rows[i].setAttribute('data-index', i + 1);
            }
        }
    }

    // Sauvegarde des notes
    let saveBtn = document.getElementById('save-all-notes');
    if (saveBtn) {
        saveBtn.addEventListener('click', function() {
            document.getElementById('notes-form').submit();
        });
    }

    // Validation des notes - Étape 1
    let validateBtn = document.getElementById('validate-all-notes');
    if (validateBtn) {
        validateBtn.addEventListener('click', function() {
            var modal1 = new bootstrap.Modal(document.getElementById('validateModal1'));
            modal1.show();
        });
    }

    // Passage à l'étape 2
    let confirmStep1 = document.getElementById('confirm-step1');
    if (confirmStep1) {
        confirmStep1.addEventListener('click', function() {
            var modal1 = bootstrap.Modal.getInstance(document.getElementById('validateModal1'));
            modal1.hide();
            setTimeout(function() {
                var modal2 = new bootstrap.Modal(document.getElementById('validateModal2'));
                modal2.show();
            }, 300);
        });
    }

    // Export Excel
    let exportExcelBtn = document.getElementById('export-excel');
    if (exportExcelBtn) {
        exportExcelBtn.addEventListener('click', function() {
            exportTableToExcel();
        });
    }

    // Export PDF
    let exportPdfBtn = document.getElementById('export-pdf');
    if (exportPdfBtn) {
        exportPdfBtn.addEventListener('click', function() {
            exportTableToPDF();
        });
    }

    // Fonction d'export Excel - orientation gauche vers droite
    function exportTableToExcel() {
        let table = document.getElementById('notes-table');
        let titre = '{{ titre_00 }} - {{ titre_01 }}';

        let html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel">';
        html += '<head><meta charset="UTF-8"><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet>';
        html += '<x:Name>Notes</x:Name><x:WorksheetOptions></x:WorksheetOptions>';
        html += '</x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head>';
        html += '<body dir="ltr"><table border="1" style="direction: ltr;">';

        // Header
        html += '<tr>';
        let headers = table.querySelectorAll('thead th');
        headers.forEach(function(th) {
            if (th.style.display !== 'none') {
                html += '<th style="background-color: #4a5568; color: white; font-weight: bold;">' + th.innerText.replace(/\n/g, ' ') + '</th>';
            }
        });
        html += '</tr>';

        // Body
        let rows = table.querySelectorAll('tbody tr');
        rows.forEach(function(row) {
            html += '<tr>';
            let cells = row.querySelectorAll('td');
            cells.forEach(function(td) {
                if (td.style.display !== 'none') {
                    let input = td.querySelector('input');
                    let value = input ? input.value : td.innerText.trim();
                    html += '<td>' + value + '</td>';
                }
            });
            html += '</tr>';
        });

        html += '</table></body></html>';

        let blob = new Blob([html], { type: 'application/vnd.ms-excel;charset=utf-8' });
        let link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'notes_' + titre.replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, '_') + '.xls';
        link.click();
    }

    // Fonction d'export PDF
    function exportTableToPDF() {
        let titre = '{{ titre_00 }} - {{ titre_01 }}';
        let printWindow = window.open('', '_blank');
        printWindow.document.write('<html dir="rtl"><head><title>Notes - ' + titre + '</title>');
        printWindow.document.write('<style>');
        printWindow.document.write('body { font-family: Arial, sans-serif; direction: rtl; }');
        printWindow.document.write('h2 { text-align: center; margin-bottom: 20px; }');
        printWindow.document.write('table { width: 100%; border-collapse: collapse; font-size: 11px; }');
        printWindow.document.write('th, td { border: 1px solid #333; padding: 5px; text-align: center; }');
        printWindow.document.write('th { background-color: #4a5568; color: white; }');
        printWindow.document.write('.text-success { color: green; } .text-danger { color: red; }');
        printWindow.document.write('@media print { body { -webkit-print-color-adjust: exact; } }');
        printWindow.document.write('</style></head><body>');
        printWindow.document.write('<h2>نقاط طلاب: ' + titre + '</h2>');

        let table = document.getElementById('notes-table').cloneNode(true);
        // Remove inputs and replace with their values
        table.querySelectorAll('input').forEach(function(input) {
            let span = document.createElement('span');
            span.textContent = input.value;
            input.parentNode.replaceChild(span, input);
        });

        printWindow.document.write(table.outerHTML);
        printWindow.document.write('</body></html>');
        printWindow.document.close();

        setTimeout(function() {
            printWindow.print();
        }, 500);
    }

    // Calcul automatique de la note finale
    document.querySelectorAll('.note-input').forEach(input => {
        input.addEventListener('input', function() {
            updateNoteFinaleLive(this);
        });
    });

    function updateNoteFinaleLive(input) {
        let etudiantId = input.name.split('_').pop();
        let row = input.closest('tr');

        let notePresence = parseFloat(row.querySelector(`input[name="note_presence_${etudiantId}"]`)?.value) || 0;
        let noteParticipe = parseFloat(row.querySelector(`input[name="note_participe_HW_${etudiantId}"]`)?.value) || 0;
        let noteControle1 = parseFloat(row.querySelector(`input[name="note_controle_1_${etudiantId}"]`)?.value) || 0;
        let noteControle2 = parseFloat(row.querySelector(`input[name="note_controle_2_${etudiantId}"]`)?.value) || 0;
        let bonusSeance = parseFloat(row.querySelector(`input[name="total_sup_seance_${etudiantId}"]`)?.value) || 0;

        let noteFinale = Math.min(20, notePresence + noteParticipe + noteControle1 + noteControle2 + bonusSeance);

        // Mettre à jour l'affichage de la note finale - c'est la DERNIÈRE cellule avec data-col="notes"
        let cells = row.querySelectorAll('td[data-col="notes"]');
        let noteFinaleCel = cells[cells.length - 1]; // La dernière cellule "notes" = النهائية
        if (noteFinaleCel) {
            let strong = noteFinaleCel.querySelector('strong');
            if (strong) {
                strong.querySelector('small').textContent = noteFinale.toFixed(2);
                strong.className = noteFinale >= 10 ? 'text-success' : 'text-danger';
            }
        }

        // Mettre à jour l'attribut data pour le tri
        row.setAttribute('data-note_finale', noteFinale);

        // Calculer la mention
        let mention = '';
        if (noteFinale >= 16) mention = 'ممتاز';
        else if (noteFinale >= 14) mention = 'جيد جداً';
        else if (noteFinale >= 12) mention = 'جيد';
        else if (noteFinale >= 10) mention = 'مقبول';
        else mention = 'لا شيء';

        let mentionBadge = row.querySelector('td[data-col="mention"] .badge small');
        if (mentionBadge) {
            mentionBadge.textContent = mention;
            mentionBadge.parentElement.className = 'badge badge-compact ' + getMentionClass(mention);
        }
    }

    function getMentionClass(mention) {
        switch(mention) {
            case 'ممتاز': return 'bg-success';
            case 'جيد جداً': return 'bg-info';
            case 'جيد': return 'bg-primary';
            case 'مقبول': return 'bg-warning';
            default: return 'bg-danger';
        }
    }

    // Validation des limites
    document.querySelectorAll('.note-input').forEach(input => {
        input.addEventListener('blur', function() {
            let min = parseFloat(this.min);
            let max = parseFloat(this.max);
            let value = parseFloat(this.value);

            if (value < min) this.value = min;
            if (value > max) this.value = max;

            updateNoteFinaleLive(this);
        });
    });

    // Tri par défaut sur nom_fr au chargement de la page
    window.addEventListener('load', function() {
        let nomFrHeader = Array.from(ths).find(th =>
            th.getAttribute('data-col') === 'nom_fr' && th.classList.contains('sortable')
        );

        if (nomFrHeader) {
            nomFrHeader.click();
        }
    });
});
</script>
{% endblock %}
