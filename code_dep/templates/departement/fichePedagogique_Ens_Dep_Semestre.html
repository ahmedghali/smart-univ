{% load static %}
{% load custom_filters %}

<!DOCTYPE html>
<html dir="rtl" lang="ar">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  {% if title %}
  <title>{{title}}</title>
  {% else %}
  <title>الجامعة الذكية</title>
  {% endif %}

  <!-- Global static -->
  <link rel="shortcut icon" type="text/css" href="{% static '/images/logo-no-background.ico' %}">
  <link rel="stylesheet" type="text/css" href="{% static '/css/all.min.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static '/css/bootstrap.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static '/css/baseInterface_pdf.css' %}">

<style>
  @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
  
  /* Modern styles - A4 Portrait version */
  * {
    box-sizing: border-box;
  }
  
  body {
    font-family: 'Cairo', Arial, sans-serif !important;
    font-size: 12px !important;
    line-height: 1.4;
    background: #f8f9fa;
    margin: 0;
    padding: 15px;
  }
  
  .main-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 15px;
    margin: 0 auto;
    max-width: 210mm;
    height: auto;
    display: flex;
    flex-direction: column;
    width: 100%;
  }
  
  /* Header styles */
  .header-section {
    background: white;
    color: #343a40;
    border: none;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  .logo-section {
    flex: 0 0 80px;
  }
  
  .logo-section img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: none;
    background: white;
    padding: 2px;
  }
  
  .university-info {
    flex: 1;
    text-align: center;
    padding: 0 15px;
  }
  
  .university-info h5 {
    margin: 3px 0;
    font-size: 16px;
    font-weight: 700;
    color: #343a40;
    line-height: 1.3;
  }
  
  .university-info h6 {
    margin: 0;
    font-size: 13px;
    font-weight: 400;
    color: #6c757d;
    line-height: 1.1;
  }
  
  .academic-year {
    flex: 0 0 120px;
    text-align: center;
    font-size: 11px;
    color: #6c757d;
  }
  
  /* Title section */
  .title-section {
    background: rgb(246, 247, 248);
    color: #343a40;
    text-align: center;
    padding: 12px;
    border: none;
    border-radius: 3px;
    margin-bottom: 12px;
  }
  
  .title-section h4 {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
  }
  
  .semester-indicator {
    font-size: 14px;
    margin-top: 5px;
    background: #e9ecef;
    padding: 3px 10px;
    border-radius: 3px;
    display: inline-block;
    font-weight: 600;
  }
  
  /* Teacher info */
  .teacher-info {
    background: white;
    color: #343a40;
    padding: 10px 15px;
    border: none;
    border-radius: 6px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 8px;
  }
  
  .teacher-info span {
    font-size: 12px;
    font-weight: 600;
    margin-left: 20px;
  }
  
  .teacher-info .label {
    font-weight: 700;
    margin-left: 5px;
  }
  
  /* Content area */
  .content-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .semester-container {
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 6px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 10px;
  }
  
  .semester-header {
    background: #e9ecef;
    color: #343a40;
    padding: 8px;
    text-align: center;
    font-size: 16px;
    font-weight: 700;
    border-bottom: 2px solid #dee2e6;
  }
  
  .semester-content {
    display: flex;
    min-height: 320px;
  }
  
  .table-section {
    flex: 1;
    padding: 8px;
  }
  
  /* Volume section moved to bottom */
  .volume-section-bottom {
    background: #f8f9fa;
    padding: 12px;
    margin: 10px 0;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    text-align: center;
  }
  
  .volume-section-bottom h6 {
    margin: 3px 0;
    font-size: 12px;
    font-weight: 600;
    color: #343a40;
    line-height: 1.3;
  }
  
  .volume-section-bottom .total {
    font-size: 14px;
    font-weight: 700;
    color: #343a40;
    border-bottom: 2px solid #dee2e6;
    padding-bottom: 5px;
    margin-bottom: 8px;
  }
  
  /* Modern table */
  .modern-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
    background: white;
  }
  
  .modern-table th {
    background: #f8f9fa !important;
    color: #000000 !important;
    padding: 4px 3px;
    text-align: center;
    font-weight: 700;
    font-size: 10px;
    border: 1px solid #dee2e6;
    white-space: nowrap;
    line-height: 1.2;
  }
  
  .modern-table td {
    padding: 8px 4px;
    text-align: center;
    border: 1px solid #dee2e6;
    font-size: 10px;
    background: white;
    line-height: 1.6;
  }
  
  .modern-table tr:nth-child(even) td {
    background: #f8f9fa;
  }
  
  .modern-table tr:hover td {
    background: #e9ecef;
    transition: background 0.2s ease;
  }
  
  /* Signatures - Clean without borders */
  .signatures {
    background: white;
    padding: 15px;
    display: flex;
    justify-content: space-around;
    font-weight: 700;
    font-size: 14px;
    margin-top: 10px;
  }
  
  .signature-box {
    text-align: center;
    padding: 20px 15px;
    min-height: 80px;
    min-width: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    font-weight: 700;
    font-size: 14px;
  }

  /* Print styles */
  @media print {
    @page {
      size: A4 portrait;
      margin: 10mm;
    }
    
    body {
      background: white !important;
      padding: 0 !important;
      margin: 0 !important;
      font-size: 11px !important;
      color: black !important;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    
    .main-container {
      box-shadow: none !important;
      border-radius: 0 !important;
      background: white !important;
      border: none !important;
      page-break-inside: avoid !important;
      width: 210mm !important;
      max-width: 210mm !important;
      height: auto !important;
      padding: 10mm !important;
      margin: 0 !important;
    }
    
    .header-section,
    .title-section,
    .teacher-info,
    .semester-header,
    .volume-section-bottom,
    .signatures,
    .semester-container {
      background: white !important;
      color: black !important;
      border: none !important;
      box-shadow: none !important;
      page-break-inside: avoid !important;
    }
    
    .semester-container {
      border: 2px solid #dee2e6 !important;
      border-radius: 6px !important;
      box-shadow: none !important;
      page-break-inside: avoid !important;
    }
    
    .semester-header {
      background: #e9ecef !important;
      color: #343a40 !important;
      border-bottom: 2px solid #dee2e6 !important;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    
    .modern-table th {
      background: #f8f9fa !important;
      color: black !important;
      border: 1px solid #dee2e6 !important;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    
    .modern-table td {
      background: white !important;
      color: black !important;
      border: 1px solid #dee2e6 !important;
    }
    
    .modern-table tr:nth-child(even) td {
      background: #f8f9fa !important;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    
    .modern-table tr:hover td {
      background: white !important;
    }
    
    .volume-section-bottom .total {
      color: #343a40 !important;
      border-bottom: 2px solid #dee2e6 !important;
    }
    
    .logo-section img {
      border: none !important;
      width: 60px !important;
      height: 60px !important;
    }
    
    .signatures {
      margin-top: 10mm !important;
      page-break-inside: avoid !important;
      background: transparent !important;
    }
    
    .signature-space {
      height: 80px !important;
      margin-bottom: 10px !important;
    }
    
    .content-area {
      height: auto !important;
      gap: 10px !important;
    }
    
    .semester-indicator {
      background: #e9ecef !important;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
  }
  
  /* Responsive adjustments */
  @media (max-width: 1200px) {
    .teacher-info {
      font-size: 11px;
    }
  }
  
  @media (max-width: 768px) {
    .main-container {
      padding: 10px;
      margin: 5px;
    }
    
    .teacher-info {
      flex-direction: column;
      gap: 5px;
    }
    
    .header-section {
      flex-direction: column;
      gap: 10px;
      text-align: center;
    }
    
    .semester-content {
      flex-direction: column;
    }
  }
</style>

</head>

<body>
  
  {% if all_classes == 0 %}
  <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #e9ecef; color: #343a40; padding: 30px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); border: 2px solid #dee2e6;">
    <h2 style="margin: 0; font-size: 24px; text-align: center;">لا حصص في السداسي {{semestre_num}} → لا بطاقة بيداغوجية</h2>
  </div>
  {% else %}

  <div class="main-container">
    <!-- Header moderne -->
    <div class="header-section">
      <div class="logo-section">
        <img src="{% static '/images/logoOuargla.png' %}" alt="Logo Univ-Ouargla">
      </div>
      <div class="university-info mb-2">
        <h5>وزارة التعليم العالي والبحث العلمي</h5>
        <h5>{{univ}}</h5>
        <h5>كلية {{my_Fac}} - قسم {{my_Dep}}</h5>
      </div>
      <div class="academic-year">
        <div>السنة الجامعية</div>
        <div style="font-weight: 700; font-size: 13px;">2025/2024</div>
      </div>
    </div>

    <!-- Titre principal -->
    <div class="title-section mb-4">
      <h4>بطاقة المتابعة البيداغوجية للأستاذ</h4>
      <div class="semester-indicator">
        السداسي {% if semestre_num == 1 %}الأول{% else %}الثاني{% endif %}
      </div>
    </div>

    <!-- Informations enseignant -->
    <div class="teacher-info mb-2">
      <span><span class="label">الأستاذ:</span>{{myEns.enseignant.nom_ar}} {{myEns.enseignant.prenom_ar}}</span>
      <span><span class="label">الرتبة:</span>{{myEns.enseignant.grade}}</span>
      <span><span class="label">الاختصاص:</span>{{myEns.enseignant.specialite_ar}}</span>
      <span><span class="label">الصفة:</span>{{myEns.get_statut_display}}</span>
    </div>

    <!-- Zone de contenu principal -->
    <div class="content-area">
      <!-- Semestre sélectionné -->
      <div class="semester-container">
        <div class="semester-header">
          السداسي {% if semestre_num == 1 %}الأول{% else %}الثاني{% endif %}
        </div>
        <div class="semester-content">
          <div class="table-section">
            <table class="modern-table">
              <thead>
                <tr>
                  <th>الرقم</th>
                  <th>اسم المقياس</th>
                  <th>الوحدة</th>
                  <th>اليوم</th>
                  <th>الحصة</th>
                  <th>المكان</th>
                  <th>المستوى</th>
                  <th>المجموعة</th>
                  <th>التخصص</th>
                  <th>النوع</th>
                  <th>الحجم الساعي</th>
                  <th>الملاحظة</th>
                </tr>
              </thead>
              <tbody>
                {% for x in all_Classe_Ens %}
                  <tr>
                    <td>{{forloop.counter}}</td>
                    <td style="font-weight: 600;">{{x.matiere.nom_fr}}</td>
                    <td>{{x.matiere.unite.nom_ar}}</td>
                    <td>{{x.get_jour_display}}</td>
                    <td>{{x.temps}}</td>
                    <td>{% if x.lieu %}{{x.lieu}}{% else %}-{% endif %}</td>
                    <td>{{x.niv_spe_dep_sg.niv_spe_dep.niveau}} - {{x.niv_spe_dep_sg.niv_spe_dep.specialite.reforme}}</td>
                    
                    <td>{% if x.type == 'Cours' %} {{x.niv_spe_dep_sg.section.nom_ar}} 
                      {% else %}{{x.niv_spe_dep_sg.section.nom_ar}}.{{x.niv_spe_dep_sg.groupe.nom_ar}} {% endif %}</td>
                    <td>{{x.niv_spe_dep_sg.niv_spe_dep.specialite.nom_ar}}</td>
                    <td style="font-weight: 600;">{{x.type}}</td>
                    <td style="font-weight: 700;">
                      {% if x.type == 'Cours' %}2.25
                      {% elif x.type == 'TD' %}1.5
                      {% elif x.type == 'TP' %}1.5{% endif %}
                    </td>
                    <td>{{x.observation|default:"-"}}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Volume section moved to bottom -->
      <div class="volume-section-bottom">
        <h6 class="total">مجموع الحجم الساعي: {{vol_hor_Total}}</h6>
        <h6>الدروس: {{vol_hor_cours}} - الأعمال الموجهة: {{vol_hor_TD}} - الأعمال التطبيقية: {{vol_hor_TP}}</h6>
        <h6>عدد الحصص: {{all_Classe_Ens|length}}</h6>
      </div>
      
      <!-- Signatures labels -->
      <div class="signatures">
        <div class="signature-box">الأستاذ</div>
        <div class="signature-box">رئيس القسم</div>
        <div class="signature-box">عميد الكلية</div>
      </div>
    </div>

    <!-- Empty space for manual signatures -->
    <div class="signature-space"></div>
  </div>
  {% endif %}

  <!-- Scripts -->
  <script src="{% static '/js/jquery-3.7.1.min.js' %}" defer></script>
  <script src="{% static '/js/bootstrap.bundle.js' %}" defer></script>
  <script src="{% static '/js/all.min.js' %}" defer></script>
  <script src="{% static '/js/scriptDate.js' %}" defer></script>

  <!-- Capture et impression comme image -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // Fonction pour capturer la fiche comme image et l'imprimer
    function captureAndPrint() {
      const element = document.querySelector('.main-container');
      
      // Récupérer le nom de l'enseignant pour le nom du fichier
      const teacherName = '{{myEns.enseignant.nom_fr}} {{myEns.enseignant.prenom_fr}}';
      const semestre = '{{semestre_num}}';
      const fileName = `Fiche pédagogique S${semestre} - ${teacherName}`;
      
      html2canvas(element, {
        scale: 2, // Réduit pour équilibrer qualité et performance
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff',
        width: element.offsetWidth,
        height: element.offsetHeight,
        scrollX: 0,
        scrollY: 0,
        logging: false,
        onclone: function(clonedDoc) {
          // Améliorer la qualité dans le clone
          const clonedContainer = clonedDoc.querySelector('.main-container');
          if (clonedContainer) {
            clonedContainer.style.transform = 'none';
            clonedContainer.style.webkitTransform = 'none';
          }
        }
      }).then(canvas => {
        // Créer une nouvelle fenêtre pour l'impression
        const printWindow = window.open('', '_blank');
        
        printWindow.document.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <title>${fileName}</title>
            <style>
              @page {
                size: A4 portrait;
                margin: 10mm;
              }
              body {
                margin: 0;
                padding: 0;
                display: flex;
                justify-content: center;
                align-items: flex-start;
                min-height: 100vh;
                background: white;
              }
              img {
                width: 190mm; /* Ajusté pour tenir dans les marges de 10mm */
                height: auto;
                max-height: 277mm; /* Ajusté pour marges */
                display: block;
                object-fit: contain;
              }
              @media print {
                body {
                  margin: 0 !important;
                  padding: 0 !important;
                }
                img {
                  width: 190mm !important;
                  height: auto !important;
                  max-height: 277mm !important;
                  object-fit: contain !important;
                }
              }
            </style>
          </head>
          <body>
            <img src="${canvas.toDataURL('image/png', 1.0)}" alt="Fiche Pédagogique S${semestre}">
          </body>
          </html>
        `);
        
        printWindow.document.close();
        
        // Attendre que l'image soit chargée puis imprimer
        printWindow.onload = function() {
          setTimeout(() => {
            printWindow.print();
            printWindow.close(); // Fermer après impression
          }, 1000);
        };
      }).catch(err => {
        console.error('Erreur lors de la capture:', err);
        // Fallback vers l'impression normale
        window.print();
      });
    }
    
    // Écouter les événements de raccourci clavier
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
        e.preventDefault();
        captureAndPrint();
      }
    });
    
    document.addEventListener("DOMContentLoaded", function () {
      console.log('Fiche pédagogique S{{semestre_num}} chargée avec capture d\'image améliorée');
    });
  </script>

</body>

</html>