{% extends 'departement/base_Dep.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<div class="grey_zone m-1 p-2 col-lg-8">
    <h4 class="border-bottom border-danger text-dark mb-3">ุฅุฏุงุฑุฉ ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ</h4>
    
    <div class="comment p-2"> 
        <form id="matieres_form" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="row g-2 mb-3">
                <div class="col-md-3">
                    <label class="form-label fw-bold">ุงูุฅุตูุงุญ:</label>
                    <select id="refs" name="reforme" class="form-select">
                        <option disabled selected>-----ุฅุฎุชุฑ ุงูุฅุตูุงุญ-----</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">ุงููุณุชูู:</label>
                    <select id="nivs" name="niveau" class="form-select">
                        <option disabled selected>-----ุฅุฎุชุฑ ุงููุณุชูู-----</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">ุงูุชุฎุตุต:</label>
                    <select id="spts" name="specialite" class="form-select">
                        <option disabled selected>-----ุฅุฎุชุฑ ุงูุชุฎุตุต-----</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">ุงูุณุฏุงุณู:</label>
                    <select id="semestres" name="semestre" class="form-select">
                        <option disabled selected>-----ุฅุฎุชุฑ ุงูุณุฏุงุณู-----</option>
                    </select>
                </div>
            </div>

            <!-- Boutons d'action principaux -->
            <div class="mb-3 d-flex gap-2">
                <button type="button" id="btn_afficher" class="btn btn-success">
                    <i class="fas fa-list"></i> ุฅุธูุงุฑ ูุงุฆูุฉ ุงูููุงุฏ
                </button>
                <button type="button" id="btn_show_import" class="btn btn-primary" style="display: none;">
                    <i class="fas fa-plus"></i> ุฅุถุงูุฉ ููุงุฏ ุฌุฏูุฏุฉ
                </button>
            </div>

            <!-- Section d'import de fichier Excel -->
            <div class="mb-3" id="div_import_section" style="display: none;">
                <div class="alert alert-info">
                    <h6 class="fw-bold text-primary mb-3">
                        <i class="fas fa-file-excel"></i> ุงุณุชูุฑุงุฏ ุงูููุงุฏ ูู ููู Excel
                    </h6>
                    
                    <div class="mb-3">
                        <label for="file_matieres" class="form-label fw-bold">ููู Excel:</label>
                        <input type="file" id="file_matieres" name="file_matieres" 
                               class="form-control" accept=".xlsx,.xls" required>
                        <div class="form-text">ุงูุฃุนูุฏุฉ ุงููุทููุจุฉ: ุงูุงุณู ุจุงูุนุฑุจูุฉุ ุงูุงุณู ุจุงููุฑูุณูุฉุ ุงูููุฏุ ุงููุนุงููุ ุงููุฑูุฏูุชุ ุงููุญุฏุฉ</div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="button" id="btn_import" class="btn btn-primary">
                            <i class="fas fa-upload"></i> ุงุณุชูุฑุงุฏ ุงูููุงุฏ
                        </button>
                        <button type="button" id="btn_cancel_import" class="btn btn-secondary">
                            <i class="fas fa-times"></i> ุฅูุบุงุก
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <!-- Messages de statut -->
        <div id="status_messages" class="mt-3"></div>
    </div>
</div>

<!-- Zone d'affichage du tableau des matiรจres -->
<div class="grey_zone m-1 p-2" id="matieres_table_container" style="display: none;">
    <div id="matieres_table">
        <!-- Le tableau des matiรจres apparaรฎtra ici -->
    </div>
</div>

<!-- ุฏููู ุงุณุชูุฑุงุฏ ุงูููุงุฏ -->
<div class="grey_zone m-1 p-3 col-lg-11" id="guide_section" style="display: none;">
    <div class="card border-info">
        <div class="card-header bg-info text-white">
            <h6 class="mb-0"><i class="fas fa-info-circle"></i> ุฏููู ุงุณุชูุฑุงุฏ ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ</h6>
        </div>
        <div class="card-body">
            
            <!-- ูููู ุงูููู -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <h6 class="text-primary"><i class="fas fa-table"></i> ุงูุฃุนูุฏุฉ ุงููุทููุจุฉ:</h6>
                    <table class="table table-sm table-bordered">
                        <thead class="table-dark">
                            <tr><th>ุงูุนููุฏ</th><th>ุญุงูุฉ</th><th>ูุซุงู</th></tr>
                        </thead>
                        <tbody>
                            <tr class="table-danger">
                                <td><strong>ุงูุงุณู ุจุงูุนุฑุจูุฉ</strong></td>
                                <td><span class="badge bg-danger">ุฅุฌุจุงุฑู</span></td>
                                <td>ุงูุฑูุงุถูุงุช</td>
                            </tr>
                            <tr class="table-danger">
                                <td><strong>ุงูุงุณู ุจุงููุฑูุณูุฉ</strong></td>
                                <td><span class="badge bg-danger">ุฅุฌุจุงุฑู</span></td>
                                <td>Mathรฉmatiques</td>
                            </tr>
                            <tr class="table-warning">
                                <td><strong>ุงูููุฏ</strong></td>
                                <td><span class="badge bg-warning">ุงุฎุชูุงุฑู</span></td>
                                <td>MATH101</td>
                            </tr>
                            <tr class="table-info">
                                <td><strong>ุงููุนุงูู</strong></td>
                                <td><span class="badge bg-info">ุงุฎุชูุงุฑู</span></td>
                                <td>3</td>
                            </tr>
                            <tr class="table-info">
                                <td><strong>ุงููุฑูุฏูุช</strong></td>
                                <td><span class="badge bg-info">ุงุฎุชูุงุฑู</span></td>
                                <td>6</td>
                            </tr>
                            <tr class="table-info">
                                <td><strong>ุงููุญุฏุฉ</strong></td>
                                <td><span class="badge bg-info">ุงุฎุชูุงุฑู</span></td>
                                <td>ุฃุณุงุณูุฉ</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="col-md-6">
                    <h6 class="text-success"><i class="fas fa-cogs"></i> ูุนูููุงุช ุฅุถุงููุฉ:</h6>
                    <div class="card border-light mb-2">
                        <div class="card-body p-2">
                            <h6 class="card-title text-primary">ุงููุนุงูู:</h6>
                            <small class="d-block text-muted">ูุฒู ุงููุงุฏุฉ ูู ุงูุญุณุงุจ ุงูููุงุฆู ููุฏุฑุฌุงุช</small>
                        </div>
                    </div>
                    <div class="card border-light mb-2">
                        <div class="card-body p-2">
                            <h6 class="card-title text-warning">ุงููุฑูุฏูุช:</h6>
                            <small class="d-block text-muted">ุนุฏุฏ ุงูุณุงุนุงุช ุงููุนุชูุฏุฉ ูููุงุฏุฉ</small>
                        </div>
                    </div>
                    <div class="card border-light">
                        <div class="card-body p-2">
                            <h6 class="card-title text-success">ุงููุญุฏุฉ:</h6>
                            <small class="d-block text-muted">ุชุตููู ุงููุงุฏุฉ (ุฃุณุงุณูุฉุ ูููุฌูุฉุ ุงุณุชูุดุงููุฉุ ุฃูููุฉ)</small>
                        </div>
                    </div>

                    <h6 class="text-info mt-3"><i class="fas fa-list"></i> ุฃููุงุน ุงููุญุฏุงุช:</h6>
                    <ul class="list-unstyled small">
                        <li><span class="badge bg-primary">ุฃุณุงุณูุฉ</span> - ุงูููุงุฏ ุงูุฃุณุงุณูุฉ</li>
                        <li><span class="badge bg-success">ูููุฌูุฉ</span> - ููุงุฏ ุงููููุฌูุฉ</li>
                        <li><span class="badge bg-warning">ุงุณุชูุดุงููุฉ</span> - ููุงุฏ ุงุณุชูุดุงููุฉ</li>
                        <li><span class="badge bg-info">ุฃูููุฉ</span> - ููุงุฏ ุฃูููุฉ</li>
                    </ul>
                </div>
            </div>

            <!-- ูุซุงู ุนููู -->
            <h6 class="text-primary"><i class="fas fa-file-excel"></i> ูุซุงู ููุญุชูู ุงูููู:</h6>
            <div class="table-responsive mb-3">
                <table class="table table-sm table-bordered table-striped">
                    <thead class="table-primary">
                        <tr>
                            <th>ุงูุงุณู ุจุงูุนุฑุจูุฉ</th><th>ุงูุงุณู ุจุงููุฑูุณูุฉ</th><th>ุงูููุฏ</th><th>ุงููุนุงูู</th><th>ุงููุฑูุฏูุช</th><th>ุงููุญุฏุฉ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>ุงูุฑูุงุถูุงุช</td><td>Mathรฉmatiques</td><td>MATH101</td><td>3</td><td>6</td><td>ุฃุณุงุณูุฉ</td>
                        </tr>
                        <tr>
                            <td>ุงูููุฒูุงุก</td><td>Physique</td><td>PHYS101</td><td>3</td><td>6</td><td>ุฃุณุงุณูุฉ</td>
                        </tr>
                        <tr class="table-warning">
                            <td>ุงูููููุงุก</td><td>Chimie</td><td></td><td>2</td><td>4</td><td></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- ููุงุนุฏ ูููุฉ -->
            <div class="row">
                <div class="col-md-6">
                    <div class="alert alert-danger p-2">
                        <h6><i class="fas fa-times-circle"></i> ููููุน:</h6>
                        <ul class="mb-0 small">
                            <li>ุชุฑู ุงูุฃุณูุงุก ูุงุฑุบุฉ</li>
                            <li>ุชูุฑุงุฑ ุฃุณูุงุก ุงูููุงุฏ</li>
                            <li>ุชุบููุฑ ุฃุณูุงุก ุงูุฃุนูุฏุฉ</li>
                            <li>ุงุณุชุฎุฏุงู ุฑููุฒ ุฎุงุตุฉ ูู ุงูุฃููุงุฏ</li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-success p-2">
                        <h6><i class="fas fa-check-circle"></i> ูุทููุจ:</h6>
                        <ul class="mb-0 small">
                            <li>ุญูุธ ุงูููู ุจุตูุบุฉ .xlsx</li>
                            <li>ุงูุชุฃูุฏ ูู ุตุญุฉ ุฃุณูุงุก ุงูููุงุฏ</li>
                            <li>ุงุณุชุฎุฏุงู ุฃุฑูุงู ุตุญูุญุฉ ูููุนุงููุงุช</li>
                            <li>ูุฑุงุฌุนุฉ ุงูุจูุงูุงุช ูุจู ุงูุงุณุชูุฑุงุฏ</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- ุชุญููู ุงููููุฐุฌ -->
            <div class="text-center mt-3">
                <button class="btn btn-outline-primary btn-sm" onclick="downloadMatieresTemplate()">
                    <i class="fas fa-download"></i> ุชุญููู ูููุฐุฌ Excel
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
    @media print {
        .btn, .form-control, form, .card-header, .alert-danger, .alert-success {
            display: none !important;
        }
        .alert-info { border: 2px solid #000 !important; }
    }
    .badge { font-size: 0.75em; }
    .table-sm th, .table-sm td { padding: 0.25rem; }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    // Variables obligatoires
    var refsUrl = "{{ refs_url }}";
    var nivsUrl = "{{ nivs_url }}";
    var sptsUrl = "{{ spts_url }}";
    var semestresUrl = "{{ semestres_url }}";
    var matieresUrl = "{{ matieres_url }}";
    var importMatieresUrl = "{% url 'depa:import-matieres' %}";
    
    // Debug
    console.log('๐ Variables dรฉfinies dans le template:');
    console.log('refsUrl:', refsUrl);
    console.log('nivsUrl:', nivsUrl);
    console.log('sptsUrl:', sptsUrl);
    console.log('semestresUrl:', semestresUrl);
    console.log('matieresUrl:', matieresUrl);
    console.log('importMatieresUrl:', importMatieresUrl);

    // ุชุญููู ูููุฐุฌ Excel ููููุงุฏ
    function downloadMatieresTemplate() {
        const content = "ุงูุงุณู ุจุงูุนุฑุจูุฉ,ุงูุงุณู ุจุงููุฑูุณูุฉ,ุงูููุฏ,ุงููุนุงูู,ุงููุฑูุฏูุช,ุงููุญุฏุฉ\n" +
                       "ุงูุฑูุงุถูุงุช,Mathรฉmatiques,MATH101,3,6,ุฃุณุงุณูุฉ\n" +
                       "ุงูููุฒูุงุก,Physique,PHYS101,3,6,ุฃุณุงุณูุฉ\n" +
                       "ุงูููููุงุก,Chimie,CHEM101,2,4,ุฃุณุงุณูุฉ\n" +
                       "ุงููููุฌูุฉ,Mรฉthodologie,METH101,2,4,ูููุฌูุฉ\n" +
                       "ุงูุฅุนูุงู ุงูุขูู,Informatique,INFO101,3,6,ุฃุณุงุณูุฉ\n";
        
        const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'ูููุฐุฌ_ุงุณุชูุฑุงุฏ_ุงูููุงุฏ.csv';
        link.click();
        URL.revokeObjectURL(link.href);
        
        setTimeout(() => {
            alert('ุชู ุชุญููู ุงููููุฐุฌ ุจูุฌุงุญ! ููููู ุงูุขู ุชุนุฏููู ูุฅุถุงูุฉ ุจูุงูุงุช ุงูููุงุฏ.');
        }, 500);
    }

    // Gestion des boutons et affichage
    document.addEventListener('DOMContentLoaded', function() {
        const btnAfficher = document.getElementById('btn_afficher');
        const btnShowImport = document.getElementById('btn_show_import');
        const btnCancelImport = document.getElementById('btn_cancel_import');
        const divImportSection = document.getElementById('div_import_section');
        const guideSection = document.getElementById('guide_section');
        const matieresTableContainer = document.getElementById('matieres_table_container');

        // Afficher les matiรจres
        btnAfficher?.addEventListener('click', function() {
            // Vรฉrifier que tous les champs sont sรฉlectionnรฉs
            const reforme = document.getElementById('refs').value;
            const niveau = document.getElementById('nivs').value;
            const specialite = document.getElementById('spts').value;
            const semestre = document.getElementById('semestres').value;

            if (!reforme || !niveau || !specialite || !semestre) {
                alert('ูุฑุฌู ุงุฎุชูุงุฑ ุฌููุน ุงูุญููู ุงููุทููุจุฉ');
                return;
            }

            // Afficher seulement le conteneur du tableau
            matieresTableContainer.style.display = 'block';
            btnShowImport.style.display = 'inline-block';
            // NE PAS afficher le guide ici
            
            // Ici vous pouvez ajouter le code pour charger les matiรจres via AJAX
            console.log('Chargement des matiรจres pour:', {reforme, niveau, specialite, semestre});
        });

        // Afficher la section d'import ET le guide
        btnShowImport?.addEventListener('click', function() {
            divImportSection.style.display = 'block';
            guideSection.style.display = 'block'; // Afficher le guide ici
            this.style.display = 'none';
        });

        // Annuler l'import
        btnCancelImport?.addEventListener('click', function() {
            divImportSection.style.display = 'none';
            guideSection.style.display = 'none'; // Cacher le guide aussi
            btnShowImport.style.display = 'inline-block';
            document.getElementById('file_matieres').value = '';
        });

        // Validation du fichier
        const fileInput = document.getElementById('file_matieres');
        if (fileInput) {
            fileInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const validTypes = ['.xlsx', '.xls'];
                    const fileExt = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
                    
                    if (!validTypes.includes(fileExt)) {
                        alert('ูุฑุฌู ุงุฎุชูุงุฑ ููู Excel (.xlsx ุฃู .xls)');
                        this.value = '';
                    } else if (file.size > 5 * 1024 * 1024) {
                        alert('ุญุฌู ุงูููู ูุจูุฑ ุฌุฏุงู (ุฃูุซุฑ ูู 5 ููุฌุงุจุงูุช)');
                        this.value = '';
                    }
                }
            });
        }
    });
</script>

<script src="{% static './departement/js/list_matiere.js' %}" defer></script>
{% endblock %}