{% extends 'departement/base_Dep.html' %}
{% load static %}
{% block content %}
{% load crispy_forms_tags%}

<script>
  window.addEventListener("pageshow", function (event) {
    if (event.persisted) {
      window.location.reload();
    }
  });
</script>

<div class="grey_zone m-1 p-2">
  {% for classTime in all_Classe_Niv %}
    {% if forloop.counter == 1 %}
      <h4 class="border-bottom border-danger text-dark font-weight-bold mb-3">
        <i class="fas fa-calendar-alt"></i>
        توزيع حصص مستوى: {{classTime.niv_spe_dep_sg.niv_spe_dep}}
        <small class="text-muted">(السداسي {{semestre_num}})</small>
      </h4>
    {% endif%}
  {% endfor%}

  {% if all_classes == 0 %}
  <div class="alert alert-info text-center">
    <i class="fas fa-info-circle"></i>
    <h4 class="mb-0">لا توجد حصص لهذا المستوى في السداسي {{semestre_num}}</h4>
  </div>
  {% else %}

  <!-- Statistiques -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="fas fa-chart-bar"></i>
        إحصائيات الحصص
      </h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3">
          <div class="stat-card text-center p-3 bg-light rounded">
            <h3 class="text-primary mb-0">{{all_classes}}</h3>
            <small class="text-muted">إجمالي الحصص</small>
          </div>
        </div>
        <div class="col-md-2">
          <div class="stat-card text-center p-3 bg-success-subtle rounded">
            <h4 class="text-success mb-0">{{nbr_Cours}}</h4>
            <small class="text-muted">دروس (Cours)</small>
          </div>
        </div>
        <div class="col-md-2">
          <div class="stat-card text-center p-3 bg-warning-subtle rounded">
            <h4 class="text-warning mb-0">{{nbr_TD}}</h4>
            <small class="text-muted">أعمال موجهة (TD)</small>
          </div>
        </div>
        <div class="col-md-2">
          <div class="stat-card text-center p-3 bg-info-subtle rounded">
            <h4 class="text-info mb-0">{{nbr_TP}}</h4>
            <small class="text-muted">أعمال تطبيقية (TP)</small>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card text-center p-3 bg-secondary-subtle rounded">
            <h4 class="text-secondary mb-0">{{nbr_SS}}</h4>
            <small class="text-muted">خرجات ميدانية (SS)</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Emploi du temps -->
  <div class="card">
    <div class="card-header bg-dark text-white">
      <h5 class="mb-0">
        <i class="fas fa-table"></i>
        الجدول الزمني الأسبوعي
      </h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover table-sm table-bordered text-center mb-0">
          <thead class="table-dark">
            <tr>
              <th class="time-header">الحصة</th>
              <th>السبت</th>
              <th>الأحد</th>
              <th>الإثنين</th>
              <th>الثلاثاء</th>
              <th>الأربعاء</th>
              <th>الخميس</th>
            </tr>
          </thead>
          <tbody class="timetable-body">
            
            <!-- Créneau 1: 08:00-09:30 -->
            <tr>
              <td class="time-slot">الحصة:1<br><small>08:00-09:30</small></td>
              {% for day in sevenDays %}
              <td class="class-cell">
                {% for classTime in all_Classe_Time %}
                  {% if classTime.temps == "09:30-08:00" and classTime.jour == day %}
                    <div class="class-item {% if classTime.type == 'Cours' %}cours{% elif classTime.type == 'TD' %}td{% elif classTime.type == 'TP' %}tp{% else %}ss{% endif %}">
                      <div class="type-badge">{{classTime.type}}</div>
                      <div class="subject">{{classTime.matiere.nom_fr|truncatechars:15}}</div>
                      <div class="teacher-location">{{classTime.enseignant.enseignant.nom_ar}} .{{classTime.enseignant.enseignant.prenom_ar|slice:":1"}}{% if classTime.lieu %} - {{classTime.lieu}}{% endif %}</div>
                      
                      <!-- Informations niveau/spécialité/groupe -->
                      <div class="level-info">
                        <div class="level-reform">{{classTime.niv_spe_dep_sg.niv_spe_dep.niveau.nom_ar}} - {{classTime.niv_spe_dep_sg.niv_spe_dep.specialite.reforme.nom_ar}}</div>
                        <div class="specialty">تخصص: {{classTime.niv_spe_dep_sg.niv_spe_dep.specialite.nom_ar}}</div>
                        <div class="group">
                          {% if classTime.niv_spe_dep_sg.section and classTime.niv_spe_dep_sg.groupe %}
                            {{classTime.niv_spe_dep_sg.section.nom_ar}} - {{classTime.niv_spe_dep_sg.groupe.nom_ar}}
                          {% elif classTime.niv_spe_dep_sg.section %}
                            قطاع: {{classTime.niv_spe_dep_sg.section.nom_ar}}
                          {% elif classTime.niv_spe_dep_sg.groupe %}
                            فوج: {{classTime.niv_spe_dep_sg.groupe.nom_ar}}
                          {% else %}
                            جميع الطلبة
                          {% endif %}
                        </div>
                      </div>

                      <!-- Boutons d'action -->
                      <div class="action-buttons mt-2">
                        <button class="btn btn-sm btn-warning btn-edit" 
                                onclick="editClasse({{classTime.id}})"
                                type="button"
                                title="تعديل">
                          <i class="fas fa-edit"></i> تعديل
                        </button>
                        <button class="btn btn-sm btn-danger btn-delete" 
                                onclick="deleteClasse({{classTime.id}})"
                                type="button"
                                title="حذف">
                          <i class="fas fa-trash"></i> حذف
                        </button>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </td>
              {% endfor %}
            </tr>

            <!-- Créneau 2: 09:40-11:10 -->
            <tr>
              <td class="time-slot">الحصة:2<br><small>09:40-11:10</small></td>
              {% for day in sevenDays %}
              <td class="class-cell">
                {% for classTime in all_Classe_Time %}
                  {% if classTime.temps == "11:10-09:40" and classTime.jour == day %}
                    <div class="class-item {% if classTime.type == 'Cours' %}cours{% elif classTime.type == 'TD' %}td{% elif classTime.type == 'TP' %}tp{% else %}ss{% endif %}">
                      <div class="type-badge">{{classTime.type}}</div>
                      <div class="subject">{{classTime.matiere.nom_fr|truncatechars:15}}</div>
                      <div class="teacher-location">{{classTime.enseignant.enseignant.nom_ar}} .{{classTime.enseignant.enseignant.prenom_ar|slice:":1"}}{% if classTime.lieu %} - {{classTime.lieu}}{% endif %}</div>
                      
                      <div class="level-info">
                        <div class="level-reform">{{classTime.niv_spe_dep_sg.niv_spe_dep.niveau.nom_ar}} - {{classTime.niv_spe_dep_sg.niv_spe_dep.specialite.reforme.nom_ar}}</div>
                        <div class="specialty">تخصص: {{classTime.niv_spe_dep_sg.niv_spe_dep.specialite.nom_ar}}</div>
                        <div class="group">
                          {% if classTime.niv_spe_dep_sg.section and classTime.niv_spe_dep_sg.groupe %}
                            {{classTime.niv_spe_dep_sg.section.nom_ar}} - {{classTime.niv_spe_dep_sg.groupe.nom_ar}}
                          {% elif classTime.niv_spe_dep_sg.section %}
                            قطاع: {{classTime.niv_spe_dep_sg.section.nom_ar}}
                          {% elif classTime.niv_spe_dep_sg.groupe %}
                            فوج: {{classTime.niv_spe_dep_sg.groupe.nom_ar}}
                          {% else %}
                            جميع الطلبة
                          {% endif %}
                        </div>
                      </div>

                      <div class="action-buttons mt-2">
                        <button class="btn btn-sm btn-warning btn-edit" 
                                onclick="editClasse({{classTime.id}})"
                                type="button">
                          <i class="fas fa-edit"></i> تعديل
                        </button>
                        <button class="btn btn-sm btn-danger btn-delete" 
                                onclick="deleteClasse({{classTime.id}})"
                                type="button">
                          <i class="fas fa-trash"></i> حذف
                        </button>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </td>
              {% endfor %}
            </tr>

            <!-- Créneau 3: 11:20-12:50 -->
            <tr>
              <td class="time-slot">الحصة:3<br><small>11:20-12:50</small></td>
              {% for day in sevenDays %}
              <td class="class-cell">
                {% for classTime in all_Classe_Time %}
                  {% if classTime.temps == "12:50-11:20" and classTime.jour == day %}
                    <div class="class-item {% if classTime.type == 'Cours' %}cours{% elif classTime.type == 'TD' %}td{% elif classTime.type == 'TP' %}tp{% else %}ss{% endif %}">
                      <div class="type-badge">{{classTime.type}}</div>
                      <div class="subject">{{classTime.matiere.nom_fr|truncatechars:15}}</div>
                      <div class="teacher-location">{{classTime.enseignant.enseignant.nom_ar}} .{{classTime.enseignant.enseignant.prenom_ar|slice:":1"}}{% if classTime.lieu %} - {{classTime.lieu}}{% endif %}</div>
                      
                      <div class="level-info">
                        <div class="level-reform">{{classTime.niv_spe_dep_sg.niv_spe_dep.niveau.nom_ar}} - {{classTime.niv_spe_dep_sg.niv_spe_dep.specialite.reforme.nom_ar}}</div>
                        <div class="specialty">تخصص: {{classTime.niv_spe_dep_sg.niv_spe_dep.specialite.nom_ar}}</div>
                        <div class="group">
                          {% if classTime.niv_spe_dep_sg.section and classTime.niv_spe_dep_sg.groupe %}
                            {{classTime.niv_spe_dep_sg.section.nom_ar}} - {{classTime.niv_spe_dep_sg.groupe.nom_ar}}
                          {% elif classTime.niv_spe_dep_sg.section %}
                            قطاع: {{classTime.niv_spe_dep_sg.section.nom_ar}}
                          {% elif classTime.niv_spe_dep_sg.groupe %}
                            فوج: {{classTime.niv_spe_dep_sg.groupe.nom_ar}}
                          {% else %}
                            جميع الطلبة
                          {% endif %}
                        </div>
                      </div>

                      <div class="action-buttons mt-2">
                        <button class="btn btn-sm btn-warning btn-edit" 
                                onclick="editClasse({{classTime.id}})"
                                type="button">
                          <i class="fas fa-edit"></i> تعديل
                        </button>
                        <button class="btn btn-sm btn-danger btn-delete" 
                                onclick="deleteClasse({{classTime.id}})"
                                type="button">
                          <i class="fas fa-trash"></i> حذف
                        </button>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </td>
              {% endfor %}
            </tr>

            <!-- Créneau 4: 13:10-14:40 -->
            <tr>
              <td class="time-slot">الحصة:4<br><small>13:10-14:40</small></td>
              {% for day in sevenDays %}
              <td class="class-cell">
                {% for classTime in all_Classe_Time %}
                  {% if classTime.temps == "14:40-13:10" and classTime.jour == day %}
                    <div class="class-item {% if classTime.type == 'Cours' %}cours{% elif classTime.type == 'TD' %}td{% elif classTime.type == 'TP' %}tp{% else %}ss{% endif %}">
                      <div class="type-badge">{{classTime.type}}</div>
                      <div class="subject">{{classTime.matiere.nom_fr|truncatechars:15}}</div>
                      <div class="teacher-location">{{classTime.enseignant.enseignant.nom_ar}} .{{classTime.enseignant.enseignant.prenom_ar|slice:":1"}}{% if classTime.lieu %} - {{classTime.lieu}}{% endif %}</div>
                      
                      <div class="level-info">
                        <div class="level-reform">{{classTime.niv_spe_dep_sg.niv_spe_dep.niveau.nom_ar}} - {{classTime.niv_spe_dep_sg.niv_spe_dep.specialite.reforme.nom_ar}}</div>
                        <div class="specialty">تخصص: {{classTime.niv_spe_dep_sg.niv_spe_dep.specialite.nom_ar}}</div>
                        <div class="group">
                          {% if classTime.niv_spe_dep_sg.section and classTime.niv_spe_dep_sg.groupe %}
                            {{classTime.niv_spe_dep_sg.section.nom_ar}} - {{classTime.niv_spe_dep_sg.groupe.nom_ar}}
                          {% elif classTime.niv_spe_dep_sg.section %}
                            قطاع: {{classTime.niv_spe_dep_sg.section.nom_ar}}
                          {% elif classTime.niv_spe_dep_sg.groupe %}
                            فوج: {{classTime.niv_spe_dep_sg.groupe.nom_ar}}
                          {% else %}
                            جميع الطلبة
                          {% endif %}
                        </div>
                      </div>

                      <div class="action-buttons mt-2">
                        <button class="btn btn-sm btn-warning btn-edit" 
                                onclick="editClasse({{classTime.id}})"
                                type="button">
                          <i class="fas fa-edit"></i> تعديل
                        </button>
                        <button class="btn btn-sm btn-danger btn-delete" 
                                onclick="deleteClasse({{classTime.id}})"
                                type="button">
                          <i class="fas fa-trash"></i> حذف
                        </button>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </td>
              {% endfor %}
            </tr>

            <!-- Créneau 5: 14:50-16:20 -->
            <tr>
              <td class="time-slot">الحصة:5<br><small>14:50-16:20</small></td>
              {% for day in sevenDays %}
              <td class="class-cell">
                {% for classTime in all_Classe_Time %}
                  {% if classTime.temps == "16:20-14:50" and classTime.jour == day %}
                    <div class="class-item {% if classTime.type == 'Cours' %}cours{% elif classTime.type == 'TD' %}td{% elif classTime.type == 'TP' %}tp{% else %}ss{% endif %}">
                      <div class="type-badge">{{classTime.type}}</div>
                      <div class="subject">{{classTime.matiere.nom_fr|truncatechars:15}}</div>
                      <div class="teacher-location">{{classTime.enseignant.enseignant.nom_ar}} .{{classTime.enseignant.enseignant.prenom_ar|slice:":1"}}{% if classTime.lieu %} - {{classTime.lieu}}{% endif %}</div>
                      
                      <div class="level-info">
                        <div class="level-reform">{{classTime.niv_spe_dep_sg.niv_spe_dep.niveau.nom_ar}} - {{classTime.niv_spe_dep_sg.niv_spe_dep.specialite.reforme.nom_ar}}</div>
                        <div class="specialty">تخصص: {{classTime.niv_spe_dep_sg.niv_spe_dep.specialite.nom_ar}}</div>
                        <div class="group">
                          {% if classTime.niv_spe_dep_sg.section and classTime.niv_spe_dep_sg.groupe %}
                            {{classTime.niv_spe_dep_sg.section.nom_ar}} - {{classTime.niv_spe_dep_sg.groupe.nom_ar}}
                          {% elif classTime.niv_spe_dep_sg.section %}
                            قطاع: {{classTime.niv_spe_dep_sg.section.nom_ar}}
                          {% elif classTime.niv_spe_dep_sg.groupe %}
                            فوج: {{classTime.niv_spe_dep_sg.groupe.nom_ar}}
                          {% else %}
                            جميع الطلبة
                          {% endif %}
                        </div>
                      </div>

                      <div class="action-buttons mt-2">
                        <button class="btn btn-sm btn-warning btn-edit" 
                                onclick="editClasse({{classTime.id}})"
                                type="button">
                          <i class="fas fa-edit"></i> تعديل
                        </button>
                        <button class="btn btn-sm btn-danger btn-delete" 
                                onclick="deleteClasse({{classTime.id}})"
                                type="button">
                          <i class="fas fa-trash"></i> حذف
                        </button>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </td>
              {% endfor %}
            </tr>

            <!-- Créneau 6: 16:30-18:00 -->
            <tr>
              <td class="time-slot">الحصة:6<br><small>16:30-18:00</small></td>
              {% for day in sevenDays %}
              <td class="class-cell">
                {% for classTime in all_Classe_Time %}
                  {% if classTime.temps == "18:00-16:30" and classTime.jour == day %}
                    <div class="class-item {% if classTime.type == 'Cours' %}cours{% elif classTime.type == 'TD' %}td{% elif classTime.type == 'TP' %}tp{% else %}ss{% endif %}">
                      <div class="type-badge">{{classTime.type}}</div>
                      <div class="subject">{{classTime.matiere.nom_fr|truncatechars:15}}</div>
                      <div class="teacher-location">{{classTime.enseignant.enseignant.nom_ar}} .{{classTime.enseignant.enseignant.prenom_ar|slice:":1"}}{% if classTime.lieu %} - {{classTime.lieu}}{% endif %}</div>
                      
                      <div class="level-info">
                        <div class="level-reform">{{classTime.niv_spe_dep_sg.niv_spe_dep.niveau.nom_ar}} - {{classTime.niv_spe_dep_sg.niv_spe_dep.specialite.reforme.nom_ar}}</div>
                        <div class="specialty">تخصص: {{classTime.niv_spe_dep_sg.niv_spe_dep.specialite.nom_ar}}</div>
                        <div class="group">
                          {% if classTime.niv_spe_dep_sg.section and classTime.niv_spe_dep_sg.groupe %}
                            {{classTime.niv_spe_dep_sg.section.nom_ar}} - {{classTime.niv_spe_dep_sg.groupe.nom_ar}}
                          {% elif classTime.niv_spe_dep_sg.section %}
                            قطاع: {{classTime.niv_spe_dep_sg.section.nom_ar}}
                          {% elif classTime.niv_spe_dep_sg.groupe %}
                            فوج: {{classTime.niv_spe_dep_sg.groupe.nom_ar}}
                          {% else %}
                            جميع الطلبة
                          {% endif %}
                        </div>
                      </div>

                      <div class="action-buttons mt-2">
                        <button class="btn btn-sm btn-warning btn-edit" 
                                onclick="editClasse({{classTime.id}})"
                                type="button">
                          <i class="fas fa-edit"></i> تعديل
                        </button>
                        <button class="btn btn-sm btn-danger btn-delete" 
                                onclick="deleteClasse({{classTime.id}})"
                                type="button">
                          <i class="fas fa-trash"></i> حذف
                        </button>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </td>
              {% endfor %}
            </tr>

          </tbody>
        </table>
      </div>
    </div>
  </div>

  {% endif %}

  <!-- Boutons de navigation -->
  <div class="row mt-4">
    <div class="col-md-6">
      <a href="{% url 'departement:list_NivSpeDep' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> العودة لقائمة المستويات
      </a>
    </div>
    <div class="col-md-6 text-end">
      <a href="{% url 'departement:list_etudiants' %}?niveau={{niveau_id}}" class="btn btn-success">
        <i class="fas fa-users"></i> قائمة طلبة هذا المستوى
      </a>
    </div>
  </div>
</div>

<!-- Modal pour modifier une classe -->
<div class="modal fade" id="editClasseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title">
          <i class="fas fa-edit"></i> تعديل الحصة
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="editClasseContent">
        <div class="text-center">
          <div class="spinner-border text-warning" role="status">
            <span class="visually-hidden">جاري التحميل...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour confirmer la suppression -->
<div class="modal fade" id="deleteClasseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-triangle"></i> تأكيد الحذف
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="deleteClasseContent">
        <div class="text-center">
          <div class="spinner-border text-danger" role="status">
            <span class="visually-hidden">جاري التحميل...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.grey_zone {
    background-color: #f8f9fa;
    border-radius: 8px;
}

.stat-card {
    transition: transform 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.timetable-body {
    font-size: 14px;
}

.time-header {
    background-color: #495057 !important;
    color: white;
    font-weight: bold;
    width: 120px;
}

.time-slot {
    background-color: #e9ecef;
    font-weight: bold;
    font-size: 13px;
    padding: 8px 4px;
    vertical-align: middle;
    width: 120px;
}

.class-cell {
    padding: 2px !important;
    vertical-align: top;
    min-height: 160px;
    max-width: 180px;
    position: relative;
}

.class-item {
    margin: 1px;
    padding: 5px;
    border-radius: 4px;
    border: 1px solid #ddd;
    background: #fff;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    font-size: 12px;
    line-height: 1.3;
    overflow: hidden;
    word-wrap: break-word;
}

.class-item.cours {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border-left: 3px solid #28a745;
}

.class-item.td {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border-left: 3px solid #ffc107;
}

.class-item.tp {
    background: linear-gradient(135deg, #cce7ff 0%, #b3d9ff 100%);
    border-left: 3px solid #007bff;
}

.class-item.ss {
    background: linear-gradient(135deg, #f8d7da 0%, #f1c2c7 100%);
    border-left: 3px solid #dc3545;
}

.type-badge {
    background: rgba(0,0,0,0.1);
    padding: 2px 5px;
    border-radius: 2px;
    font-weight: bold;
    font-size: 11px;
    margin-bottom: 3px;
    text-align: center;
}

.subject {
    font-weight: bold;
    color: #333;
    margin-bottom: 3px;
    font-size: 12px;
}

.teacher-location {
    color: #666;
    font-size: 11px;
    margin-bottom: 2px;
}

.level-info {
    border-top: 1px solid rgba(0,0,0,0.1);
    padding-top: 2px;
    margin-top: 2px;
}

.level-reform {
    color: #495057;
    font-size: 9px;
    font-weight: bold;
    margin-bottom: 1px;
}

.specialty {
    color: #6c757d;
    font-size: 8px;
    margin-bottom: 1px;
    font-style: italic;
}

.group {
    color: #007bff;
    font-size: 8px;
    font-weight: bold;
    margin-bottom: 3px;
}

.action-buttons {
    border-top: 1px solid rgba(0,0,0,0.15);
    padding-top: 3px;
    display: flex;
    gap: 3px;
    justify-content: center;
}

.action-buttons .btn {
    font-size: 9px;
    padding: 2px 5px;
    border-radius: 3px;
    flex: 1;
}

.action-buttons .btn i {
    font-size: 8px;
}

.action-buttons .btn:hover {
    transform: scale(1.05);
    transition: all 0.2s;
}

@media (max-width: 768px) {
    .timetable-body {
        font-size: 10px;
    }
    
    .class-item {
        font-size: 9px;
        padding: 3px;
    }
    
    .time-slot {
        font-size: 9px;
        width: 80px;
    }
    
    .action-buttons .btn {
        font-size: 7px;
        padding: 1px 3px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
console.log('Script chargé avec succès');

// Fonction pour modifier une classe
function editClasse(classeId) {
    console.log('Édition de la classe:', classeId);
    
    const modalElement = document.getElementById('editClasseModal');
    const contentDiv = document.getElementById('editClasseContent');
    
    if (!modalElement) {
        console.error('Modal editClasseModal non trouvé');
        alert('خطأ: لم يتم العثور على نافذة التعديل');
        return;
    }
    
    // Afficher le spinner
    contentDiv.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-warning" role="status">
                <span class="visually-hidden">جاري التحميل...</span>
            </div>
        </div>
    `;
    
    // Créer et afficher le modal
    let modal;
    if (typeof bootstrap !== 'undefined') {
        modal = new bootstrap.Modal(modalElement);
        modal.show();
    } else {
        // Fallback pour jQuery si Bootstrap 5 n'est pas disponible
        $(modalElement).modal('show');
    }
    
    // Charger le formulaire de modification
    fetch(`/departement/classe/${classeId}/edit/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Erreur réseau');
            }
            return response.text();
        })
        .then(html => {
            contentDiv.innerHTML = html;
        })
        .catch(error => {
            console.error('Erreur lors du chargement:', error);
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i>
                    حدث خطأ أثناء تحميل البيانات
                </div>
            `;
        });
}

// Fonction pour supprimer une classe
function deleteClasse(classeId) {
    console.log('Suppression de la classe:', classeId);
    
    const modalElement = document.getElementById('deleteClasseModal');
    const contentDiv = document.getElementById('deleteClasseContent');
    
    if (!modalElement) {
        console.error('Modal deleteClasseModal non trouvé');
        alert('خطأ: لم يتم العثور على نافذة الحذف');
        return;
    }
    
    // Afficher le spinner
    contentDiv.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-danger" role="status">
                <span class="visually-hidden">جاري التحميل...</span>
            </div>
        </div>
    `;
    
    // Créer et afficher le modal
    let modal;
    if (typeof bootstrap !== 'undefined') {
        modal = new bootstrap.Modal(modalElement);
        modal.show();
    } else {
        // Fallback pour jQuery si Bootstrap 5 n'est pas disponible
        $(modalElement).modal('show');
    }
    
    // Charger la confirmation de suppression
    fetch(`/departement/classe/${classeId}/delete/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Erreur réseau');
            }
            return response.text();
        })
        .then(html => {
            contentDiv.innerHTML = html;
        })
        .catch(error => {
            console.error('Erreur lors du chargement:', error);
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i>
                    حدث خطأ أثناء تحميل البيانات
                </div>
            `;
        });
}

// Fonction pour soumettre le formulaire de modification
function submitEditForm(event, classeId) {
    event.preventDefault();
    console.log('Soumission du formulaire de modification pour:', classeId);
    
    const form = event.target;
    const formData = new FormData(form);
    
    // Afficher un indicateur de chargement
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> جاري الحفظ...';
    submitBtn.disabled = true;
    
    fetch(`/departement/classe/${classeId}/edit/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fermer le modal
            const modalElement = document.getElementById('editClasseModal');
            if (typeof bootstrap !== 'undefined') {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) modal.hide();
            } else {
                $(modalElement).modal('hide');
            }
            
            // Afficher un message de succès
            showSuccessMessage(data.message);
            
            // Recharger la page après 1.5 secondes
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            // Réactiver le bouton
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            
            // Afficher les erreurs
            showErrorMessage(data.message || 'حدث خطأ أثناء التعديل');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        // Réactiver le bouton
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        
        showErrorMessage('حدث خطأ أثناء التعديل');
    });
}

// Fonction pour confirmer la suppression
function confirmDelete(classeId) {
    console.log('Confirmation de suppression pour:', classeId);
    
    // Obtenir le CSRF token
    const csrfToken = getCookie('csrftoken');
    
    // Afficher un indicateur de chargement
    const deleteBtn = event.target;
    const originalText = deleteBtn.innerHTML;
    deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> جاري الحذف...';
    deleteBtn.disabled = true;
    
    fetch(`/departement/classe/${classeId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fermer le modal
            const modalElement = document.getElementById('deleteClasseModal');
            if (typeof bootstrap !== 'undefined') {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) modal.hide();
            } else {
                $(modalElement).modal('hide');
            }
            
            // Afficher un message de succès
            showSuccessMessage(data.message);
            
            // Recharger la page après 1.5 secondes
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            // Réactiver le bouton
            deleteBtn.innerHTML = originalText;
            deleteBtn.disabled = false;
            
            showErrorMessage(data.message || 'حدث خطأ أثناء الحذف');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        // Réactiver le bouton
        deleteBtn.innerHTML = originalText;
        deleteBtn.disabled = false;
        
        showErrorMessage('حدث خطأ أثناء الحذف');
    });
}

// Fonction pour obtenir le cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Afficher un message de succès
function showSuccessMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 99999; min-width: 300px;';
    alertDiv.innerHTML = `
        <i class="fas fa-check-circle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

// Afficher un message d'erreur
function showErrorMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 99999; min-width: 300px;';
    alertDiv.innerHTML = `
        <i class="fas fa-exclamation-circle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Vérifier que tout est chargé au démarrage de la page
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM chargé');
    console.log('Bootstrap disponible:', typeof bootstrap !== 'undefined');
    console.log('jQuery disponible:', typeof $ !== 'undefined');
});
</script>
{% endblock %}