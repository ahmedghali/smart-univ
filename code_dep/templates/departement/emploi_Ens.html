{% extends 'departement/base_Dep.html' %}
{% block content %}
{% load crispy_forms_tags%}
{% load custom_filters %}

<script>
  // Ecoute l'événement 'pageshow' pour recharger automatiquement la page lorsqu'elle est revisitée
  window.addEventListener("pageshow", function (event) {
    if (event.persisted) {  // Vérifie si la page vient du cache du navigateur
      window.location.reload();  // Recharge la page automatiquement
    }
  });
</script>

<div class="grey_zone m-1 p-2">
  <!-- En-tête avec informations de l'enseignant -->
  {% for x in all_Classe_Ens %}
  {% if forloop.counter == 1 %}
  <h4 class="border-bottom border-danger text-dark font-weight-bold mb-3">
    <i class="fas fa-chalkboard-teacher"></i>
    حصص الأستاذ: {{x.enseignant}}
    <small class="text-danger">(إجمالي: {{all_classes}} حصة)</small>
  </h4>
  
  <!-- Informations du semestre -->
  {% endif %}
  {% endfor %}

  {% if all_classes == 0 %}
  <div class="alert alert-info text-center">
    <i class="fas fa-info-circle"></i>
    <h4 class="mb-0">لا توجد حصص</h4>
  </div>
  {% else %}

  <!-- Statistiques -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="fas fa-chart-bar"></i>
        إحصائيات الحصص
      </h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3">
          <div class="stat-card text-center p-3 bg-success-subtle rounded">
            <h4 class="text-success mb-0">{{nbr_Cours}}</h4>
            <small class="text-muted">دروس (Cours)</small>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card text-center p-3 bg-warning-subtle rounded">
            <h4 class="text-warning mb-0">{{nbr_TD}}</h4>
            <small class="text-muted">أعمال موجهة (TD)</small>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card text-center p-3 bg-info-subtle rounded">
            <h4 class="text-info mb-0">{{nbr_TP}}</h4>
            <small class="text-muted">أعمال تطبيقية (TP)</small>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card text-center p-3 bg-secondary-subtle rounded">
            <h4 class="text-secondary mb-0">{{nbr_SS}}</h4>
            <small class="text-muted">خرجات ميدانية (SS)</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mini emploi du temps -->
  <div class="card mb-4">
    <div class="card-header bg-dark text-white">
      <h5 class="mb-0">
        <i class="fas fa-table"></i>
        نظرة عامة على الجدول الزمني
      </h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover table-sm table-bordered text-center mb-0">
          <thead class="table-dark">
            <tr>
              <th class="time-header">الحصة</th>
              <th>السبت</th>
              <th>الأحد</th>
              <th>الإثنين</th>
              <th>الثلاثاء</th>
              <th>الأربعاء</th>
              <th>الخميس</th>
            </tr>
          </thead>
          <tbody class="timetable-body">
            {% for clas in sixClasses %}
            <tr>
              <td class="time-slot">
                <small>{{ clas|slice:"0:15" }}</small>
              </td>
              {% for day in sevenDays %}
              <td class="class-cell">
                {% for classTime in all_Classe_Time %}
                  {% if classTime.temps == clas and classTime.jour == day %}
                    <div class="mini-class-item {% if classTime.type == 'Cours' %}cours{% elif classTime.type == 'TD' %}td{% elif classTime.type == 'TP' %}tp{% else %}ss{% endif %}">
                      <div class="type-badge">{{classTime.type}}</div>
                      <div class="subject">{{classTime.matiere.nom_fr|truncatechars:15}}</div>
                      <div>
                        {{classTime.niv_spe_dep_sg.niv_spe_dep.niveau}} {{classTime.niv_spe_dep_sg.niv_spe_dep.specialite.reforme}}
                      </div>
                      <div class="subject">
                        {% if classTime.type == 'Cours' %}
                          {{ classTime.niv_spe_dep_sg.section }}
                        {% else %}
                            {{ classTime.niv_spe_dep_sg.section }} . {{ classTime.niv_spe_dep_sg.groupe }}
                        {% endif %}                      
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Tableau détaillé des cours -->
  <!-- Tableau détaillé des cours mis à jour -->
<div class="card">
  <div class="card-header bg-secondary text-white">
    <h5 class="mb-0">
      <i class="fas fa-list"></i>
      تفاصيل الحصص
    </h5>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm mb-0">
        <thead class="table-secondary">
          <tr>
            <th>#</th>
            <th>
              <i class="fas fa-calendar-day"></i>
              اليوم
            </th>
            <th>
              <i class="fas fa-tag"></i>
              النوع
            </th>
            <th>
              <i class="fas fa-clock"></i>
              الحصة
            </th>
            <th>
              <i class="fas fa-book"></i>
              المادة
            </th>
            <th>
                <i class="fas fa-book"></i>
                Moodle
              </th>
            <th>
              <i class="fas fa-layer-group"></i>
              المستوى
            </th>
            <th>
              <i class="fas fa-map-marker-alt"></i>
              المكان
            </th>
            <th class="text-center">
              <i class="fas fa-percentage"></i>
              نسبة التدريس
            </th>
            <th class="text-center">
              <i class="fas fa-user-times"></i>
              غيابات الطلبة
            </th>
            <!-- ✅ NOUVELLE COLONNE POUR LES NOTES -->
            <th class="text-center">
              <i class="fas fa-graduation-cap"></i>
              نقاط الطلبة
            </th>
          </tr>
        </thead>
        <tbody>
          {% for x in all_Classe_Ens %}
          <tr>
            <td>
              <span class="badge bg-primary">{{forloop.counter}}</span>
            </td>
            
            <!-- اليوم -->
            <td>
              {% if x.seance_created == True %}
                <a href="{% url 'depa:list_Seance_Ens' x.id %}" class="text-decoration-none">
                  <span class="badge bg-success">{{x.get_jour_display}}</span>
                </a>
              {% else %}
                <span class="badge bg-secondary">{{x.get_jour_display}}</span>
              {% endif %}
            </td>

            <!-- النوع -->
            <td>
              <span class="type-badge-detailed {% if x.type == 'Cours' %}cours{% elif x.type == 'TD' %}td{% elif x.type == 'TP' %}tp{% else %}ss{% endif %}">
                {{x.type}}
              </span>
            </td>

            <!-- الحصة -->
            <td>
              <small class="text-muted">{{x.temps|slice:"0:15"}}</small>
            </td>

            <!-- المادة -->
            <td>
              <strong>{{x.matiere.nom_fr}}</strong>
            </td>

            <!-- Moodle -->
              <td>
              {% if x.lien_moodle %}

                <a href="{{ x.lien_moodle }}" target="_blank" class="btn btn-sm btn-outline-success">
                  <i class="fas fa-external-link-alt"></i>
                </a>
                        
              {% else %}
                <span class="badge bg-warning text-dark">
                      <i class="fas fa-exclamation-triangle"></i>
                    </span>
              {% endif %}
              </td>

            <!-- المستوى -->
            <td>
              <div class="level-info-detailed">
                <div class="level-reform">
                {{x.niv_spe_dep_sg.niv_spe_dep.niveau}} {{x.niv_spe_dep_sg.niv_spe_dep.specialite.reforme}} {{x.niv_spe_dep_sg.niv_spe_dep.specialite.nom_ar}}
                -
                      {% if x.type == 'Cours' %}
                        {{ x.niv_spe_dep_sg.section }}
                      {% else %}
                          {{ x.niv_spe_dep_sg.section }} . {{ x.niv_spe_dep_sg.groupe }}
                      {% endif %}                      
                    </div>
              </div>
            </td>

            <!-- المكان -->
            <td>
              {% if x.lieu != None %}
                <i class="fas fa-map-marker-alt text-danger"></i>
                {{x.lieu}}
              {% else %}
                <span class="text-muted">غير محدد</span>
              {% endif %}
            </td>

            <!-- نسبة التدريس -->
            <td class="text-center">
              {% if x.seance_created == True %}
                <div class="progress" style="height: 20px;">
                  <div class="progress-bar bg-success" role="progressbar" style="width: {{x.taux_avancement}}%">
                    {{x.taux_avancement}}%
                  </div>
                </div>
              {% else %}
                <a class="btn btn-secondary btn-sm text-decoration-none text-light"
                   href="{% url 'depa:new_Sceance_Ens' x.id x.enseignant.id %}">
                  إنشاء الدروس
                </a>
              {% endif %}
            </td>

            <!-- غيابات الطلبة -->
            <td class="text-center">
              {% if x.abs_liste_Etu == True %}
                <a href="{% url 'depa:list_absences_classe' x.id %}"
                   class="btn btn-sm btn-outline-danger text-decoration-none">
                  <i class="fas fa-user-times"></i>
                  غيابات الطلبة
                </a>
              {% else %}
                <span class="text-muted">غير متاح</span>
              {% endif %}
            </td>

            <!-- ✅ NOUVELLE COLONNE POUR LES NOTES -->
            <td class="text-center">
              {% if x.notes_liste_Etu == True %}
                <a href="{% url 'depa:list_Notes_Etu_Classe' x.id %}"
                   class="btn btn-sm btn-outline-success text-decoration-none">
                  <i class="fas fa-graduation-cap"></i>
                  نقاط الطلبة
                </a>
              {% else %}
                  لا  توجد نقاط
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
  {% endif %}
</div>

{% endblock %}

{% block extra_css %}
<style>
.grey_zone {
    background-color: #f8f9fa;
    border-radius: 8px;
}

.stat-card {
    transition: transform 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
}

/* Style du mini tableau emploi du temps */
.timetable-body {
    font-size: 12px;
}

.time-header {
    background-color: #495057 !important;
    color: white;
    font-weight: bold;
    width: 100px;
}

.time-slot {
    background-color: #e9ecef;
    font-weight: bold;
    font-size: 11px;
    padding: 8px 4px;
    vertical-align: middle;
    width: 100px;
}

.class-cell {
    padding: 2px !important;
    vertical-align: top;
    min-height: 60px;
    max-width: 120px;
    position: relative;
}

.mini-class-item {
    margin: 1px;
    padding: 3px;
    border-radius: 3px;
    border: 1px solid #ddd;
    background: #fff;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    font-size: 10px;
    line-height: 1.2;
    overflow: hidden;
    word-wrap: break-word;
}

.mini-class-item.cours {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border-left: 2px solid #28a745;
}

.mini-class-item.td {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border-left: 2px solid #ffc107;
}

.mini-class-item.tp {
    background: linear-gradient(135deg, #cce7ff 0%, #b3d9ff 100%);
    border-left: 2px solid #007bff;
}

.mini-class-item.ss {
    background: linear-gradient(135deg, #f8d7da 0%, #f1c2c7 100%);
    border-left: 2px solid #dc3545;
}

.type-badge {
    background: rgba(0,0,0,0.1);
    padding: 1px 3px;
    border-radius: 2px;
    font-weight: bold;
    font-size: 9px;
    margin-bottom: 2px;
    text-align: center;
}

.subject {
    font-weight: bold;
    color: #333;
    font-size: 9px;
}

/* Badges pour le tableau détaillé */
.type-badge-detailed {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: bold;
    text-transform: uppercase;
}

.type-badge-detailed.cours {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.type-badge-detailed.td {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.type-badge-detailed.tp {
    background-color: #cce7ff;
    color: #004085;
    border: 1px solid #b3d9ff;
}

.type-badge-detailed.ss {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f1c2c7;
}

.level-info-detailed {
    font-size: 12px;
}

.level-reform {
    color: #495057;
    font-weight: bold;
}

/* Responsive */
@media (max-width: 768px) {
    .timetable-body {
        font-size: 10px;
    }
    
    .mini-class-item {
        font-size: 8px;
        padding: 2px;
    }
    
    .time-slot {
        font-size: 9px;
        width: 80px;
    }
    
    .type-badge-detailed {
        font-size: 10px;
        padding: 2px 4px;
    }
}

/* Animations */
.card {
    transition: box-shadow 0.3s ease;
}

.card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.table tbody tr:hover {
    background-color: rgba(0,123,255,0.1);
}

.progress {
    border-radius: 10px;
}

.progress-bar {
    transition: width 0.3s ease;
}
</style>


<script>
window.addEventListener('load', function() {
    // Attendre que tout soit chargé
    setTimeout(function() {
        var tbody = document.querySelector('.table tbody');
        if (!tbody) return;
        
        var rows = Array.from(tbody.querySelectorAll('tr'));
        if (rows.length === 0) return;
        
        // Ordre des jours
        var jours = {
            'Samedi': 1, 'السبت': 1,
            'Dimanche': 2, 'الأحد': 2,
            'Lundi': 3, 'الاثنين': 3,
            'Mardi': 4, 'الثلاثاء': 4,
            'Mercredi': 5, 'الأربعاء': 5,
            'Jeudi': 6, 'الخميس': 6,
            'Vendredi': 7, 'الجمعة': 7
        };
        
        // Trier
        rows.sort(function(a, b) {
            // Jour (colonne 2)
            var jourA = a.cells[1].textContent.trim();
            var jourB = b.cells[1].textContent.trim();
            var ordreA = jours[jourA] || 999;
            var ordreB = jours[jourB] || 999;
            
            if (ordreA !== ordreB) {
                return ordreA - ordreB;
            }
            
            // Heure (colonne 4)
            var tempsA = a.cells[3].textContent.trim();
            var tempsB = b.cells[3].textContent.trim();
            
            // Extraire heure de début (après le tiret)
            var heureA = tempsA.split('-')[1] || tempsA;
            var heureB = tempsB.split('-')[1] || tempsB;
            
            // Convertir en minutes
            var partsA = heureA.split(':');
            var partsB = heureB.split(':');
            var minA = parseInt(partsA[0]) * 60 + parseInt(partsA[1]);
            var minB = parseInt(partsB[0]) * 60 + parseInt(partsB[1]);
            
            return minA - minB;
        });
        
        // Réinsérer les lignes
        for (var i = 0; i < rows.length; i++) {
            tbody.appendChild(rows[i]);
            // Mettre à jour le numéro
            rows[i].cells[0].querySelector('.badge').textContent = i + 1;
        }
        
        console.log('✅ Tri terminé');
    }, 1000);
});
</script>


{% endblock %}