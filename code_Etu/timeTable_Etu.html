{% extends 'etudiant/base_Etu.html' %}
{% block content %}
{% load crispy_forms_tags %}
{% load custom_filters %}

<script>
  // Ecoute l'événement 'pageshow' pour recharger automatiquement la page lorsqu'elle est revisitée
  window.addEventListener("pageshow", function (event) {
    if (event.persisted) {  // Vérifie si la page vient du cache du navigateur
      window.location.reload();  // Recharge la page automatiquement
    }
  });
</script>

<!-- Sélecteur de semestre - identique à l'enseignant -->
<div class="grey_zone m-1 p-2 mb-3">
  <div class="row align-items-center">
    <div class="col-md-6">
      <h3 class="mb-0">
        <i class="fas fa-user-graduate"></i>
        إستعمال الزمن - الطالب: {{my_Etu.nom_ar}} {{my_Etu.prenom_ar}}
      </h3>
    </div>
    <div class="col-md-6 text-end">
      <div class="btn-group" role="group">
        {% for semestre in all_semestres %}
          <a href="?semestre={{semestre.numero}}" 
             class="btn {% if semestre_selected == semestre.numero|stringformat:'s' %}btn-primary{% else %}btn-outline-primary{% endif %}">
            السداسي {{semestre.numero}}
          </a>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

{% if all_classes == 0 %}
    <div class="alert alert-info text-center">
      <i class="fas fa-info-circle"></i>
      <h4 class="mb-0">لا توجد حصص في السداسي {{semestre_selected}}</h4>
      <p class="text-muted">يرجى التحقق من السداسي الآخر أو التواصل مع إدارة القسم</p>
    </div>
{% else %}
  
<div class="grey_zone m-1 p-2">

  <!-- En-tête avec informations -->
  <h4 class="border-bottom border-danger text-dark font-weight-bold mb-3">
    <i class="fas fa-calendar-alt"></i>
    توزيع حصص الطالب - السداسي {{semestre_selected}}
    <small class="text-muted">(إجمالي: {{all_classes}} حصة)</small>
  </h4>
  
  <!-- Liens utiles - adaptés pour l'étudiant -->
  <h5>
    <a href="#" class="text-primary fw-bold" style="text-decoration: none;">
      النتائج الأكاديمية
    </a>
    |
    <a href="#" class="text-success fw-bold" style="text-decoration: none;">
      المقرر الدراسي
    </a>
    |
    <a href="#" class="text-info fw-bold" style="text-decoration: none;">
      الغيابات والحضور
    </a>
    |
    <a href="#" class="text-warning fw-bold" style="text-decoration: none;">
      جدول الامتحانات
    </a>
    |
    <a href="#" class="text-secondary fw-bold" style="text-decoration: none;">
      المكتبة الرقمية
    </a>
  </h5>

  <!-- Statistiques - même structure que l'enseignant -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="fas fa-chart-bar"></i>
        إحصائيات السداسي {{semestre_selected}}
      </h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-2">
          <div class="stat-card text-center p-3 bg-danger-subtle rounded">
            <h4 class="text-danger mb-0">{{all_classes}}</h4>
            <small class="text-muted">العدد الكلي للحصص</small>
          </div>
        </div>
        <div class="col-md-2">
          <div class="stat-card text-center p-3 bg-success-subtle rounded">
            <h4 class="text-success mb-0">{{nbr_Cours}}</h4>
            <small class="text-muted">دروس (Cours)</small>
          </div>
        </div>
        <div class="col-md-2">
          <div class="stat-card text-center p-3 bg-warning-subtle rounded">
            <h4 class="text-warning mb-0">{{nbr_TD}}</h4>
            <small class="text-muted">أعمال موجهة (TD)</small>
          </div>
        </div>
        <div class="col-md-2">
          <div class="stat-card text-center p-3 bg-info-subtle rounded">
            <h4 class="text-info mb-0">{{nbr_TP}}</h4>
            <small class="text-muted">أعمال تطبيقية (TP)</small>
          </div>
        </div>
        <div class="col-md-2">
          <div class="stat-card text-center p-3 bg-secondary-subtle rounded">
            <h4 class="text-secondary mb-0">{{nbr_SS}}</h4>
            <small class="text-muted">خرجات ميدانية (SS)</small>
          </div>
        </div>
        <div class="col-md-2">
          <div class="stat-card text-center p-3 bg-dark-subtle rounded">
            <div style="font-size: 12px;">
              <div><strong>إجمالي الحصص:</strong> {{stats_classes.total}}</div>
              <div><strong>عدد الأيام:</strong> {{stats_classes.jours}}</div>
              <div><strong>عدد ساعات:</strong> {{stats_classes.vol_horaire}}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mini emploi du temps - même structure que l'enseignant -->
  <div class="card mb-4">
    <div class="card-header bg-dark text-white">
      <h5 class="mb-0">
        <i class="fas fa-table"></i>
        نظرة عامة على الجدول الزمني - السداسي {{semestre_selected}}
      </h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover table-sm table-bordered text-center mb-0">
          <thead class="table-dark">
            <tr>
              <th class="time-header">الحصة</th>
              <th>السبت</th>
              <th>الأحد</th>
              <th>الإثنين</th>
              <th>الثلاثاء</th>
              <th>الأربعاء</th>
              <th>الخميس</th>
            </tr>
          </thead>
          <tbody class="timetable-body">
            {% for clas in sixClasses %}
            <tr>
              <td class="time-slot">
                <small>{{ clas|slice:"0:15" }}</small>
              </td>
              {% for day in sevenDays %}
              <td class="class-cell">
                {% for classTime in all_Classe_Time %}
                  {% if classTime.temps == clas and classTime.jour == day %}
                    <div class="mini-class-item {% if classTime.type == 'Cours' %}cours{% elif classTime.type == 'TD' %}td{% elif classTime.type == 'TP' %}tp{% else %}ss{% endif %}">
                      <div class="type-badge">{{classTime.type}}</div>
                      <div class="subject">{{classTime.matiere.nom_fr|truncatechars:15}}</div>
                      <div>
                        {{classTime.niv_spe_dep_sg.niv_spe_dep.niveau}} {{classTime.niv_spe_dep_sg.niv_spe_dep.specialite.reforme}}
                      </div>
                      <div class="subject">
                        {% if classTime.niv_spe_dep_sg.type_affectation == 'par_section' and classTime.niv_spe_dep_sg.section %}
                          {{ classTime.niv_spe_dep_sg.section }}
                        {% elif classTime.niv_spe_dep_sg.type_affectation == 'par_groupe' and classTime.niv_spe_dep_sg.groupe %}
                            {{ classTime.niv_spe_dep_sg.groupe }}
                        {% elif classTime.niv_spe_dep_sg.type_affectation == 'tous_etudiants' %}
                            جميع الطلبة
                        {% endif %}                      
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Tableau détaillé des cours - adapté pour l'étudiant -->
  <!-- Tableau détaillé des cours - Version mise à jour comme l'enseignant -->
  <div class="card">
    <div class="card-header bg-secondary text-white">
      <h5 class="mb-0">
        <i class="fas fa-list"></i>
        تفاصيل الحصص - السداسي {{semestre_selected}}
      </h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover table-sm mb-0">
          <thead class="table-secondary">
            <tr>
              <th>#</th>
              <th>
                <i class="fas fa-calendar-day"></i>
                اليوم
              </th>
              <th>
                <i class="fas fa-tag"></i>
                النوع
              </th>
              <th>
                <i class="fas fa-clock"></i>
                الحصة
              </th>
              <th>
                <i class="fas fa-book"></i>
                المادة
              </th>

              <th>
                <i class="fas fa-book"></i>
                Moodle
              </th>
              
              <th>
                <i class="fas fa-layer-group"></i>
                المستوى
              </th>
              <th>
                <i class="fas fa-user"></i>
                الأستاذ
              </th>
              <th>
                <i class="fas fa-map-marker-alt"></i>
                المكان
              </th>
              <th class="text-center">
                <i class="fas fa-percentage"></i>
                نسبة التدريس
              </th>
              <th class="text-center">
                <i class="fas fa-user-times"></i>
                الغيابات
              </th>
              <!-- ✅ NOUVELLE COLONNE POUR LES NOTES -->
              <th class="text-center">
                <i class="fas fa-graduation-cap"></i>
                نقاط الطلبة
              </th>
            </tr>
          </thead>
          <tbody>
            {% for x in all_Classe_Etu %}
            <tr>
              <td>
                <span class="badge bg-primary">{{forloop.counter}}</span>
              </td>
              
              <!-- اليوم -->
              <td>
                {% if x.seance_created == True %}
                  <a href="{% url 'etudiant:list_Seance_Etu' x.id %}" 
                    class="text-decoration-none"
                    onclick="console.log('Classe ID:', {{x.id}}); console.log('URL:', this.href); return true;">
                    <span class="badge bg-success clickable-badge">
                      {{x.get_jour_display}}
                      <i class="fas fa-arrow-left ms-1"></i>
                    </span>
                  </a>
                {% else %}
                  <span class="badge bg-secondary">{{x.get_jour_display}}</span>
                {% endif %}
              </td>

              <!-- النوع -->
              <td>
                <span class="type-badge-detailed {% if x.type == 'Cours' %}cours{% elif x.type == 'TD' %}td{% elif x.type == 'TP' %}tp{% else %}ss{% endif %}">
                  {{x.type}}
                </span>
              </td>

              <!-- الحصة -->
              <td>
                <small class="text-muted">{{x.temps|slice:"0:15"}}</small>
              </td>

              <!-- المادة -->
              <td>
                <small><strong>{{x.matiere.nom_fr}}</strong></small>
              </td>

              <!-- Moodle -->
                <td>
                {% if x.lien_moodle %}

                  <a href="{{ x.lien_moodle }}" target="_blank" class="btn btn-sm btn-outline-success">
                    <i class="fas fa-external-link-alt"></i>
                  </a>
                          
                {% else %}
                  <span class="badge bg-warning text-dark">
                        <i class="fas fa-exclamation-triangle"></i>
                      </span>
                {% endif %}
                </td>

              <!-- المستوى -->
              <td>
                <div class="level-info-detailed">
                  <div class="level-reform">
                    <small>
                      {% if x.niv_spe_dep_sg.type_affectation == 'par_section' and x.niv_spe_dep_sg.section %}
                        {{ x.niv_spe_dep_sg.section }}
                      {% elif x.niv_spe_dep_sg.type_affectation == 'par_groupe' and x.niv_spe_dep_sg.groupe %}
                        {{ x.niv_spe_dep_sg.groupe }}
                      {% elif x.niv_spe_dep_sg.type_affectation == 'tous_etudiants' %}
                        جميع الطلبة
                      {% endif %}      
                    </small>                
                  </div>
                </div>
              </td>

              <!-- الأستاذ -->
              <td>
                {% if x.enseignant %}
                  <div class="teacher-info">
                    <i class="fas fa-chalkboard-teacher text-primary"></i>
                    <small>{{x.enseignant.enseignant.nom_ar}} {{x.enseignant.enseignant.prenom_ar}}</small>
                  </div>
                {% else %}
                  <span class="text-muted">غير محدد</span>
                {% endif %}
              </td>

              <!-- المكان -->
              <td>
                {% if x.lieu != None %}
                  <i class="fas fa-map-marker-alt text-danger"></i>
                  {{x.lieu}}
                {% else %}
                  <span class="text-muted">غير محدد</span>
                {% endif %}
              </td>

              <!-- نسبة التدريس -->
              <td class="text-center">
                {% if x.seance_created == True %}
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{x.taux_avancement}}%">
                      {{x.taux_avancement}}%
                    </div>
                  </div>
                {% else %}
                  <span class="badge bg-secondary">لم تنشأ الدروس</span>
                {% endif %}
              </td>

              <!-- الغيابات -->
              <td class="text-center">
                {% if x.abs_liste_Etu == True %}
                  <a href="{% url 'etudiant:abs_Etu_Classe' x.id %}"
                     class="btn btn-sm btn-outline-danger text-decoration-none">
                    <i class="fas fa-user-times"></i>
                    عرض الغيابات
                  </a>
                {% else %}
                  <span class="text-muted">غير متاح</span>
                {% endif %}
              </td>

              <!-- ✅ NOUVELLE COLONNE POUR LES NOTES -->
              <td class="text-center">
                {% if x.notes_liste_Etu == True %}
                  <a href="{% url 'etudiant:notes_Etu_Classe' x.id %}"
                     class="btn btn-sm btn-outline-success text-decoration-none">
                    <i class="fas fa-graduation-cap"></i>
                    عرض النقاط
                  </a>
                {% else %}
                  <span class="text-muted badge bg-warning">لا توجد نقاط</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% endif %}

{% endblock %}

{% block extra_css %}
<style>
.grey_zone {
    background-color: #f8f9fa;
    border-radius: 8px;
}

.stat-card {
    transition: transform 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
}

/* Style du mini tableau emploi du temps */
.timetable-body {
    font-size: 12px;
}

.time-header {
    background-color: #495057 !important;
    color: white;
    font-weight: bold;
    width: 100px;
}

.time-slot {
    background-color: #e9ecef;
    font-weight: bold;
    font-size: 11px;
    padding: 8px 4px;
    vertical-align: middle;
    width: 100px;
}

.class-cell {
    padding: 2px !important;
    vertical-align: top;
    min-height: 60px;
    max-width: 120px;
    position: relative;
}

.mini-class-item {
    margin: 1px;
    padding: 3px;
    border-radius: 3px;
    border: 1px solid #ddd;
    background: #fff;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    font-size: 10px;
    line-height: 1.2;
    overflow: hidden;
    word-wrap: break-word;
}

.mini-class-item.cours {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border-left: 2px solid #28a745;
}

.mini-class-item.td {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border-left: 2px solid #ffc107;
}

.mini-class-item.tp {
    background: linear-gradient(135deg, #cce7ff 0%, #b3d9ff 100%);
    border-left: 2px solid #007bff;
}

.mini-class-item.ss {
    background: linear-gradient(135deg, #f8d7da 0%, #f1c2c7 100%);
    border-left: 2px solid #dc3545;
}

.type-badge {
    background: rgba(0,0,0,0.1);
    padding: 1px 3px;
    border-radius: 2px;
    font-weight: bold;
    font-size: 9px;
    margin-bottom: 2px;
    text-align: center;
}

.subject {
    font-weight: bold;
    color: #333;
    font-size: 9px;
}

/* Badges pour le tableau détaillé */
.type-badge-detailed {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: bold;
    text-transform: uppercase;
}

.type-badge-detailed.cours {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.type-badge-detailed.td {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.type-badge-detailed.tp {
    background-color: #cce7ff;
    color: #004085;
    border: 1px solid #b3d9ff;
}

.type-badge-detailed.ss {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f1c2c7;
}

.teacher-info {
    font-size: 12px;
    color: #495057;
}

/* Liens utiles */
h5 a {
    transition: all 0.3s ease;
}

h5 a:hover {
    text-decoration: underline !important;
    transform: scale(1.05);
}

/* Cards */
.card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: box-shadow 0.3s ease;
}

.card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.card-header {
    border-radius: 12px 12px 0 0 !important;
    border-bottom: none;
    font-weight: 600;
}

/* Boutons et badges */
.btn {
    border-radius: 6px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.badge {
    font-size: 0.8rem;
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
}

/* Progress bars */
.progress {
    border-radius: 10px;
    background-color: #e9ecef;
}

.progress-bar {
    border-radius: 10px;
    transition: width 0.6s ease;
}

/* Table hover effects */
.table tbody tr:hover {
    background-color: rgba(0,123,255,0.1);
}

/* Responsive */
@media (max-width: 768px) {
    .timetable-body {
        font-size: 10px;
    }
    
    .mini-class-item {
        font-size: 8px;
        padding: 2px;
    }
    
    .time-slot {
        font-size: 9px;
        width: 80px;
    }
    
    .type-badge-detailed {
        font-size: 10px;
        padding: 2px 4px;
    }
    
    .stat-card {
        margin-bottom: 1rem;
    }
    
    h5 {
        font-size: 1rem;
        line-height: 1.5;
    }
    
    h5 a {
        display: inline-block;
        margin-bottom: 0.25rem;
    }
    
    .btn-group {
        flex-direction: column;
        width: 100%;
    }
    
    .btn-group .btn {
        border-radius: 6px !important;
        margin-bottom: 0.25rem;
    }
    
    .teacher-info {
        font-size: 10px;
    }
}

@media (max-width: 576px) {
    .card-body {
        padding: 1rem;
    }
    
    .table {
        font-size: 0.8rem;
    }
    
    .table th,
    .table td {
        padding: 0.5rem 0.25rem;
    }
    
    /* Cacher certaines colonnes sur mobile */
    .table th:nth-child(6),
    .table td:nth-child(6),
    .table th:nth-child(7),
    .table td:nth-child(7) {
        display: none;
    }
}

/* Animation au chargement */
.card {
    opacity: 0;
    transform: translateY(20px);
    animation: slideUp 0.5s ease forwards;
}

.card:nth-child(2) {
    animation-delay: 0.1s;
}

.card:nth-child(3) {
    animation-delay: 0.2s;
}

@keyframes slideUp {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Couleurs */
.text-primary { color: #007bff !important; }
.text-success { color: #28a745 !important; }
.text-info { color: #17a2b8 !important; }
.text-warning { color: #ffc107 !important; }
.text-secondary { color: #6c757d !important; }
.text-danger { color: #dc3545 !important; }

.bg-primary { background-color: #007bff !important; }
.bg-success { background-color: #28a745 !important; }
.bg-info { background-color: #17a2b8 !important; }
.bg-warning { background-color: #ffc107 !important; }
.bg-secondary { background-color: #6c757d !important; }
.bg-danger { background-color: #dc3545 !important; }

/* Subtle backgrounds */
.bg-success-subtle { background-color: #d4edda !important; }
.bg-warning-subtle { background-color: #fff3cd !important; }
.bg-info-subtle { background-color: #cce7ff !important; }
.bg-danger-subtle { background-color: #f8d7da !important; }
.bg-secondary-subtle { background-color: #e9ecef !important; }
.bg-dark-subtle { background-color: #f8f9fa !important; border: 1px solid #dee2e6; }


.clickable-badge {
    cursor: pointer;
    transition: all 0.3s ease;
}

.clickable-badge:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.clickable-badge i {
    font-size: 0.7rem;
}
</style>
{% endblock %}