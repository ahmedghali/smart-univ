{% extends 'etudiant/base_Etu.html' %}
{% block content %}
{% load crispy_forms_tags %}

<div class="grey_zone m-1 p-2">
  <!-- En-tête de la page -->
  <h4 class="border-bottom border-danger text-dark font-weight-bold mb-3">
    غيابات الطالب: {{ my_Etu.nom_ar }} {{ my_Etu.prenom_ar }}
  </h4>
  <h5 class="oneBorder mb-3">
    المادة: <span class="text-danger fw-bold">{{ titre_01 }}</span> - 
    <span class="text-secondary">{{ titre_00 }}</span>
  </h5>

  <!-- Statistiques rapides -->
  <div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="stat-card bg-primary text-white p-1">
        <div class="stat-icon">
          <i class="fas fa-calendar-check"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ total_sessions }}</div>
          <div class="stat-label">إجمالي الحصص</div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="stat-card bg-success text-white p-1">
        <div class="stat-icon">
          <i class="fas fa-user-check"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ taux_presence }}%</div>
          <div class="stat-label">نسبة الحضور</div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="stat-card bg-danger text-white p-1">
        <div class="stat-icon">
          <i class="fas fa-user-times"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ total_absences }}</div>
          <div class="stat-label">إجمالي الغيابات</div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="stat-card bg-info text-white p-1">
        <div class="stat-icon">
          <i class="fas fa-clipboard-check"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ absences_justifiees }}</div>
          <div class="stat-label">الغيابات المبررة</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Message d'aide -->
  <div class="alert alert-info mb-3" role="alert">
    <i class="fas fa-info-circle me-2"></i>
    <strong>مفتاح الرموز:</strong>
    <span class="badge bg-danger ms-2">غائب</span> غائب |
    <span class="badge bg-info ms-2">غائب مبرر</span> غائب مبرر |
    <span class="badge bg-success ms-2">حاضر</span> حاضر |
    <span class="badge bg-secondary ms-2">لا توجد بيانات</span> لا توجد بيانات
  </div>

  <!-- Tableau principal des absences - CORRIGÉ -->
  <div class="table-container">
    <table class="table table-striped table-hover table-sm table-bordered align-middle" id="absence-table">
      <thead class="table-secondary">
        <tr>
          <th width="50">#</th>
          <th>التاريخ</th>
          <th>التوقيت</th>
          <th>عنوان الحصة</th>
          <th class="text-center">الحالة</th>
          <th>الملاحظات</th>
        </tr>
      </thead>
      <tbody>
        {% for seance_data in seances_with_absences %}
          <tr>
            <td class="text-center">{{ forloop.counter }}</td>
            <td>{{ seance_data.seance.date|date:"d/m/Y" }}</td>
            <td>{{ seance_data.seance.temps }}</td>
            <td>{{ seance_data.seance.intitule|default:"حصة بدون عنوان" }}</td>
            
            <!-- COLONNE ÉTAT CORRIGÉE -->
            <td class="text-center">
              {% if seance_data.status == 'absent' %}
                <span class="badge bg-danger">غائب</span>
              {% elif seance_data.status == 'absent_justifie' %}
                <span class="badge bg-info">غائب مبرر</span>
              {% elif seance_data.status == 'present' %}
                <span class="badge bg-success">حاضر</span>
              {% else %}
                <span class="badge bg-secondary">لا توجد بيانات</span>
              {% endif %}
            </td>
            
            <!-- COLONNE OBSERVATIONS CORRIGÉE -->
            <td>
              {% if seance_data.absence and seance_data.absence.obs %}
                {{ seance_data.absence.obs|truncatechars:50 }}
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="6" class="text-center py-4">
              <i class="fas fa-inbox fa-2x mb-2 text-muted"></i>
              <br>
              <span class="text-muted">لا توجد حصص مسجلة</span>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>


  <!-- Résumé final -->
  {% if total_sessions > 0 %}
  <div class="row mt-4">
    <div class="col-12">
      <div class="summary-card">
        <h6 class="summary-title">
          <i class="fas fa-chart-line me-2"></i>
          ملخص الحضور والغياب
        </h6>
        <div class="row">
          <div class="col-md-3">
            <div class="summary-item">
              <span class="summary-label">إجمالي الحصص:</span>
              <span class="summary-value">{{ total_sessions }}</span>
            </div>
          </div>
          <div class="col-md-3">
            <div class="summary-item">
              <span class="summary-label">نسبة الحضور:</span>
              <span class="summary-value text-success">{{ taux_presence }}%</span>
            </div>
          </div>
          <div class="col-md-3">
            <div class="summary-item">
              <span class="summary-label">الغيابات غير المبررة:</span>
              <span class="summary-value text-danger">{{ absences_non_justifiees }}</span>
            </div>
          </div>
          <div class="col-md-3">
            <div class="summary-item">
              <span class="summary-label">الغيابات المبررة:</span>
              <span class="summary-value text-info">{{ absences_justifiees }}</span>
            </div>
          </div>
        </div>
        
        <!-- Barre de progression -->
        <div class="progress-section mt-3">
          <label class="progress-label">نسبة الحضور</label>
          <div class="progress">
            <div class="progress-bar 
              {% if taux_presence >= 75 %}bg-success
              {% elif taux_presence >= 50 %}bg-warning  
              {% else %}bg-danger{% endif %}" 
              style="width: {{ taux_presence }}%">
              {{ taux_presence }}%
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Actions -->
  <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
    <a href="{% url 'etud:timeTable_Etu' %}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-2"></i>
      العودة إلى الجدول الزمني
    </a>
    
    <div class="d-flex gap-2">
      <button class="btn btn-outline-primary btn-sm" onclick="window.print()">
        <i class="fas fa-print me-1"></i>
        طباعة
      </button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
/* Styles généraux */
.grey_zone {
    background-color: #f8f9fa;
    border-radius: 8px;
}

.oneBorder {
    border-left: 4px solid #dc3545;
    padding-left: 10px;
}

/* Cartes de statistiques */
.stat-card {
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-3px);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    background: rgba(255, 255, 255, 0.2);
}

.stat-content {
    flex: 1;
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

/* Tableau */
.table-container {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.table {
    margin: 0;
}

.table th {
    background: #6c757d !important;
    color: white;
    font-weight: 600;
    text-align: center;
    padding: 1rem 0.75rem;
    border: none;
}

.table td {
    padding: 0.75rem;
    vertical-align: middle;
    border-bottom: 1px solid #dee2e6;
}

.table-hover tbody tr:hover {
    background-color: #fff3cd !important;
    color: #856404;
}

/* Badges */
.badge {
    font-size: 0.8rem;
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    font-weight: 600;
}

/* Carte de résumé */
.summary-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #007bff;
}

.summary-title {
    color: #2c3e50;
    font-weight: 600;
    margin-bottom: 1rem;
}

.summary-item {
    margin-bottom: 0.75rem;
}

.summary-label {
    font-weight: 500;
    color: #6c757d;
    margin-right: 0.5rem;
}

.summary-value {
    font-weight: 700;
    color: #2c3e50;
}

/* Section de progression */
.progress-section {
    margin-top: 1rem;
}

.progress-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
    display: block;
}

.progress {
    height: 12px;
    border-radius: 6px;
    background-color: #e9ecef;
}

.progress-bar {
    border-radius: 6px;
    transition: width 0.6s ease;
}

/* Boutons */
.btn {
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
}

/* Alert */
.alert {
    border-radius: 8px;
    border-left: 4px solid #17a2b8;
}

/* Responsive */
@media (max-width: 768px) {
    .stat-card {
        margin-bottom: 1rem;
        flex-direction: column;
        text-align: center;
        padding: 1rem;
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
        margin: 0 auto 0.5rem;
    }
    
    .stat-number {
        font-size: 1.5rem;
    }
    
    .table {
        font-size: 0.8rem;
    }
    
    .table th,
    .table td {
        padding: 0.5rem 0.25rem;
    }
    
    .summary-card {
        padding: 1rem;
    }
    
    .d-flex.justify-content-between {
        flex-direction: column;
        gap: 1rem;
    }
    
    .d-flex.gap-2 {
        justify-content: center;
    }
}

/* Mode impression */
@media print {
    .btn,
    .d-flex.justify-content-between,
    .alert-warning {
        display: none !important;
    }
    
    .stat-card {
        box-shadow: none;
        border: 1px solid #dee2e6;
    }
    
    .table-container {
        box-shadow: none;
    }
    
    .summary-card {
        box-shadow: none;
        border: 1px solid #dee2e6;
    }
}

/* Couleurs des badges */
.bg-danger { background-color: #dc3545 !important; }
.bg-info { background-color: #17a2b8 !important; }
.bg-success { background-color: #28a745 !important; }
.bg-secondary { background-color: #6c757d !important; }
.bg-primary { background-color: #007bff !important; }
.bg-warning { background-color: #ffc107 !important; color: #212529 !important; }

/* Améliorations texte */
.text-success { color: #28a745 !important; }
.text-danger { color: #dc3545 !important; }
.text-info { color: #17a2b8 !important; }
.text-muted { color: #6c757d !important; }
</style>
{% endblock %}